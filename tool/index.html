<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="http://localhost:8080/static/shared-styles.css">
    <link rel="stylesheet" href="http://localhost:8080/static/enemy-designer-new.css">
    <link rel="stylesheet" href="http://localhost:8080/static/item-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/perk-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/expedition-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/settlement-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/quest-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/talent-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/npc-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/server-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/chat-moderation.css">
    <link rel="stylesheet" href="http://localhost:8080/static/concept-designer.css">
    <!-- AWS Cognito SDK for token management -->
    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>
</head>
<body>
    <!-- Loading overlay - shown until global data is ready -->
    <div id="loading-overlay" style="position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;background:#0c0d12;color:#94a3b8;font-family:'Inter',sans-serif;flex-direction:column;gap:10px">
        <div style="width:20px;height:20px;border:2px solid #2a2d3a;border-top-color:#3b82f6;border-radius:50%;animation:spin .8s linear infinite"></div>
        <div id="loading-status" style="font-size:13px;font-weight:500">Loading game data‚Ä¶</div>
    </div>
    <div class="header">
        <div class="header-left">
            <h1>Dashboard</h1>
            <button id="back-to-dashboard" onclick="showPage('dashboard'); return false;" class="back-btn" style="display: none;">‚Üê Back to Dashboard</button>
        </div>
        <div class="user-info">
            <span id="username-display">Admin User</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard-content" class="page-content">
            <!-- Creation Tools Section -->
            <div class="creation-tools">
                <h3 class="section-title">Editors</h3>
                <div class="tools-grid">
                    <a href="#" onclick="showPage('items'); return false;" class="tool-card">
                        <span class="tool-card-icon">‚öîÔ∏è</span>
                        <span class="tool-card-title">Items</span>
                    </a>
                    <a href="#" onclick="showPage('perks'); return false;" class="tool-card">
                        <span class="tool-card-icon">‚ú®</span>
                        <span class="tool-card-title">Perks</span>
                    </a>
                    <a href="#" onclick="showPage('enemies'); return false;" class="tool-card">
                        <span class="tool-card-icon">üëπ</span>
                        <span class="tool-card-title">Enemies</span>
                    </a>
                    <a href="#" onclick="showPage('talents'); return false;" class="tool-card">
                        <span class="tool-card-icon">üåü</span>
                        <span class="tool-card-title">Talents</span>
                    </a>
                    <a href="#" onclick="showPage('npcs'); return false;" class="tool-card">
                        <span class="tool-card-icon">üë•</span>
                        <span class="tool-card-title">NPCs</span>
                    </a>
                    <a href="#" onclick="showPage('settlements'); return false;" class="tool-card">
                        <span class="tool-card-icon">üèòÔ∏è</span>
                        <span class="tool-card-title">Settlements</span>
                    </a>
                    <a href="#" onclick="showPage('quests'); return false;" class="tool-card">
                        <span class="tool-card-icon">üó°Ô∏è</span>
                        <span class="tool-card-title">Quests</span>
                    </a>
                    <a href="#" onclick="showPage('dungeons'); return false;" class="tool-card">
                        <span class="tool-card-icon">üó∫Ô∏è</span>
                        <span class="tool-card-title">Expeditions</span>
                    </a>
                </div>
            </div>

            <!-- Management Tools Section -->
            <div class="management-tools">
                <h3 class="section-title">Management</h3>
                <div class="tools-grid">
                    <a href="#" onclick="showPage('concept'); return false;" class="tool-card">
                        <span class="tool-card-icon">üß≠</span>
                        <span class="tool-card-title">Concept</span>
                    </a>
                    <a href="#" onclick="showPage('servers'); return false;" class="tool-card">
                        <span class="tool-card-icon">üñ•Ô∏è</span>
                        <span class="tool-card-title">Servers</span>
                    </a>
                    <a href="#" onclick="showPage('players'); return false;" class="tool-card">
                        <span class="tool-card-icon">üë§</span>
                        <span class="tool-card-title">Players</span>
                    </a>
                    <a href="#" onclick="showPage('moderation'); return false;" class="tool-card">
                        <span class="tool-card-icon">üõ°Ô∏è</span>
                        <span class="tool-card-title">Chat</span>
                    </a>
                    <a href="#" onclick="showPage('analytics'); return false;" class="tool-card">
                        <span class="tool-card-icon">üìä</span>
                        <span class="tool-card-title">Analytics</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Quest Manager Section -->
        <div id="quests-content" class="page-content" style="display: none;">
            <div class="quest-designer-container">
                <!-- Toolbar -->
                <div class="quest-toolbar">
                    <div class="quest-toolbar-left">
                        <div class="quest-settlement-select">
                            <label>Settlement:</label>
                            <select id="questSettlementSelect" onchange="window.onQuestSettlementChange && window.onQuestSettlementChange()">
                            </select>
                        </div>
                        <div class="quest-select">
                            <label>Chain:</label>
                            <select id="questSelect" onchange="window.onQuestChange && window.onQuestChange()">
                                <option value="" disabled selected>-- Select or Create --</option>
                            </select>
                        </div>
                        <div class="quest-chain-name">
                            <label>Name:</label>
                            <input type="text" id="questChainNameInput" placeholder="Chain name..." oninput="window.updateChainName && window.updateChainName(this.value)">
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <button class="quest-zoom-btn" title="Zoom Out" onclick="window.changeQuestZoom(-0.1)">‚àí</button>
                            <span id="questZoomIndicator" class="quest-zoom-indicator">100%</span>
                            <button class="quest-zoom-btn" title="Zoom In" onclick="window.changeQuestZoom(0.1)">+</button>
                        </div>
                    </div>
                    <div class="quest-toolbar-right">
                        <button id="addQuestBtn" class="btn-secondary" onclick="window.addQuestSlide()">+ Add Quest</button>
                        <button id="addOptionBtn" class="btn-primary">+ Add Option</button>
                        <button id="questGenerateBtn" class="btn-secondary">üß† Generate Quest</button>
                        <button id="saveQuestBtn" class="btn-success" onclick="window.saveQuest()">üíæ Save</button>
                    </div>
                </div>
                
                <!-- Main content area with canvas and sidebar -->
                <div class="quest-main-area">
                    <!-- Canvas Area -->
                    <div class="quest-canvas-wrapper">
                        <!-- Canvas -->
                        <div id="questCanvas" class="quest-canvas">
                            <svg id="questConnectionsSvg" class="quest-connections-svg">
                                <defs>
                                    <marker id="arrowRequires" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                        <polygon points="0 0, 10 3.5, 0 7" fill="rgb(100, 149, 237)"/>
                                    </marker>
                                </defs>
                                <path id="questConnectionPreview" class="quest-connection-preview" style="display:none"></path>
                            </svg>
                            
                            <div id="questOptionsContainer" class="quest-options-container">
                                <!-- Quest slides and option nodes rendered dynamically here -->
                            </div>
                            
                            <!-- Navigation Controls -->
                            <div class="quest-nav-controls">
                                <button class="quest-nav-btn" onclick="window.panQuestCanvas(0, 100)" title="Pan Up">‚ñ≤</button>
                                <div class="nav-row">
                                    <button class="quest-nav-btn" onclick="window.panQuestCanvas(100, 0)" title="Pan Left">‚óÄ</button>
                                    <button class="quest-nav-btn nav-center" onclick="window.resetQuestView()" title="Reset View">‚äô</button>
                                    <button class="quest-nav-btn" onclick="window.panQuestCanvas(-100, 0)" title="Pan Right">‚ñ∂</button>
                                </div>
                                <button class="quest-nav-btn" onclick="window.panQuestCanvas(0, -100)" title="Pan Down">‚ñº</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Sidebar - Option Properties -->
                    <div id="questOptionSidebar" class="quest-option-sidebar">
                        <!-- No selection state -->
                        <div id="sidebarNoSelection" class="sidebar-no-selection">
                            <span>üìã</span>
                            <p>Select a quest slide or option node to edit its properties</p>
                        </div>

                        <!-- Quest content (hidden until quest selection) -->
                        <div id="sidebarQuestContent" class="sidebar-content" style="display: none;">
                            <div class="sidebar-header sidebar-quest-preview-header">
                                <button id="sidebarQuestPreviewBtn" class="btn-primary sidebar-preview-btn" type="button">‚ñ∂ Preview Quest</button>
                                <span id="sidebarQuestId" class="sidebar-option-id">Quest ID: --</span>
                            </div>

                            <div class="sidebar-section">
                                <div class="sidebar-actions quest-bg-actions">
                                    <button id="sidebarQuestBgBtn" class="btn-secondary" onclick="window.openQuestAssetPicker && window.openQuestAssetPicker(window.questState?.selectedQuest)">üñºÔ∏è Set Background</button>
                                </div>
                                <div class="sidebar-field">
                                    <label>Travel Text</label>
                                    <textarea id="sidebarTravelText" placeholder="What happens during travel..."></textarea>
                                </div>
                                <div class="sidebar-field">
                                    <label>Failure Text</label>
                                    <textarea id="sidebarFailureText" placeholder="Failure outcome text..."></textarea>
                                </div>
                                <div class="sidebar-actions">
                                    <button id="sidebarDeleteQuest" onclick="window.deleteSelectedQuest && window.deleteSelectedQuest()">üóëÔ∏è Delete Quest</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Option content (hidden until selection) -->
                        <div id="sidebarContent" class="sidebar-content" style="display: none;">
                            <div class="sidebar-header">
                                <h3>Option Properties</h3>
                                <span id="sidebarOptionId" class="sidebar-option-id">Option ID: --</span>
                                <span id="sidebarSaveStatus" class="sidebar-save-status"></span>
                            </div>
                            
                            <!-- Option Type -->
                            <div class="sidebar-section">
                                <h4>üéØ Option Type</h4>
                                <div class="sidebar-field">
                                    <select id="sidebarOptionType">
                                        <option value="dialogue">üí¨ Dialogue</option>
                                        <option value="stat_check">üìä Stat Check</option>
                                        <option value="effect_check">‚ú® Effect Check</option>
                                        <option value="combat">‚öîÔ∏è Combat</option>
                                        <option value="faction">üè∞ Faction</option>
                                        <option value="silver">ü™ô Silver</option>
                                        <option value="end">üèÅ Quest End</option>
                                    </select>
                                </div>
                                
                                <!-- Stat Check Fields -->
                                <div id="optionTypeStatCheck" class="option-type-fields" style="display:none;">
                                    <div class="sidebar-row">
                                        <div class="sidebar-field">
                                            <label>Stat:</label>
                                            <select id="sidebarStatType">
                                                <option value="strength">Strength</option>
                                                <option value="stamina">Stamina</option>
                                                <option value="agility">Agility</option>
                                                <option value="luck">Luck</option>
                                                <option value="armor">Armor</option>
                                            </select>
                                        </div>
                                        <div class="sidebar-field">
                                            <label>Required:</label>
                                            <input type="number" id="sidebarStatRequired" placeholder="0">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Effect Check Fields -->
                                <div id="optionTypeEffectCheck" class="option-type-fields" style="display:none;">
                                    <div class="sidebar-row">
                                        <div class="sidebar-field">
                                            <label>Effect:</label>
                                            <select id="sidebarEffectId">
                                                <!-- Populated by JS from GlobalData.effects -->
                                            </select>
                                        </div>
                                        <div class="sidebar-field">
                                            <label>Amount:</label>
                                            <input type="number" id="sidebarEffectAmount" placeholder="0">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Combat Fields -->
                                <div id="optionTypeCombat" class="option-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Select Enemy:</label>
                                        <input type="hidden" id="sidebarEnemyId">
                                        <div id="questEnemyPickerGrid" class="quest-enemy-picker-grid">
                                            <!-- Enemy items populated by JS -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Faction Fields -->
                                <div id="optionTypeFaction" class="option-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Faction Required:</label>
                                        <select id="sidebarFactionRequired">
                                            <option value="">-- Select Faction --</option>
                                            <option value="order">Order</option>
                                            <option value="guild">Guild</option>
                                            <option value="companions">Companions</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Silver Fields -->
                                <div id="optionTypeSilver" class="option-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Silver Required:</label>
                                        <input type="number" id="sidebarSilverRequired" placeholder="0">
                                    </div>
                                </div>
                            </div>

                            <!-- Option Effect -->
                            <div class="sidebar-section" id="optionEffectSection">
                                <h4>‚ú® Option Effect</h4>
                                <div class="sidebar-row">
                                    <div class="sidebar-field">
                                        <label>Effect:</label>
                                        <select id="sidebarOptionEffectId">
                                            <!-- Populated by JS from GlobalData.effects -->
                                        </select>
                                    </div>
                                    <div class="sidebar-field">
                                        <label>Factor:</label>
                                        <input type="number" id="sidebarOptionEffectFactor" placeholder="0">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Rewards -->
                            <div class="sidebar-section">
                                <h4>üéÅ Reward</h4>
                                <div class="sidebar-field">
                                    <label>Reward Type:</label>
                                    <select id="sidebarRewardType">
                                        <option value="">-- None --</option>
                                        <option value="stat">üìä Stat Bonus</option>
                                        <option value="silver">ü™ô Silver</option>
                                        <option value="talent">‚≠ê Talent Point</option>
                                        <option value="item">üéí Item</option>
                                        <option value="potion">üß™ Potion</option>
                                        <option value="perk">üí™ Perk</option>
                                        <option value="blessing">üôè Blessing</option>
                                    </select>
                                </div>
                                
                                <!-- Stat Reward Fields -->
                                <div id="rewardTypeStat" class="reward-type-fields" style="display:none;">
                                    <div class="sidebar-row">
                                        <div class="sidebar-field">
                                            <label>Stat:</label>
                                            <select id="sidebarRewardStatType">
                                                <option value="strength">Strength</option>
                                                <option value="stamina">Stamina</option>
                                                <option value="agility">Agility</option>
                                                <option value="luck">Luck</option>
                                                <option value="armor">Armor</option>
                                            </select>
                                        </div>
                                        <div class="sidebar-field">
                                            <label>Amount:</label>
                                            <input type="number" id="sidebarRewardStatAmount" placeholder="0">
                                        </div>
                                    </div>
                                </div>

                                <!-- Silver Reward Fields -->
                                <div id="rewardTypeSilver" class="reward-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Silver Amount:</label>
                                        <input type="number" id="sidebarRewardSilver" placeholder="0" min="0">
                                    </div>
                                </div>
                                
                                <!-- Item Reward Fields -->
                                <div id="rewardTypeItem" class="reward-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Item:</label>
                                        <select id="sidebarRewardItem">
                                            <option value="">-- Select Item --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Potion Reward Fields -->
                                <div id="rewardTypePotion" class="reward-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Potion:</label>
                                        <select id="sidebarRewardPotion">
                                            <option value="">-- Select Potion --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Perk Reward Fields -->
                                <div id="rewardTypePerk" class="reward-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Perk:</label>
                                        <select id="sidebarRewardPerk">
                                            <option value="">-- Select Perk --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Blessing Reward Fields -->
                                <div id="rewardTypeBlessing" class="reward-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Blessing:</label>
                                        <select id="sidebarRewardBlessing">
                                            <option value="">-- Select Blessing --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Hidden checkbox for talent (used when reward type is talent) -->
                                <input type="hidden" id="sidebarRewardTalent">
                            </div>
                            
                            <!-- Actions -->
                            <div class="sidebar-actions">
                                <button id="sidebarDeleteOption" class="btn-delete" onclick="window.deleteSelectedOption()">üóëÔ∏è Delete Option</button>
                            </div>
                        </div>
                    </div>

                    <div id="questGenerateOverlay" class="generate-overlay" style="display:none;">
                        <div id="questGeneratePanel" class="generate-modal quest-generate-sidebar">
                            <div class="quest-generate-header">
                                <h3>üß† Generate Quest</h3>
                                <button id="questGenerateClose" class="btn-secondary">Close</button>
                            </div>
                            <div class="quest-generate-body">
                                <div class="generate-columns">
                                    <div class="generate-left">
                                        <div class="quest-generate-field">
                                            <label>Location</label>
                                            <input type="text" id="questGenerateLocationFilter" class="quest-generate-filter" placeholder="Search locations...">
                                            <select id="questGenerateLocation"></select>
                                        </div>
                                        <div class="quest-generate-row">
                                            <div class="quest-generate-field">
                                                <label>NPCs</label>
                                                <input type="text" id="questGenerateNpcFilter" class="quest-generate-filter" placeholder="Search NPCs...">
                                                <select id="questGenerateNpcs" multiple></select>
                                            </div>
                                            <div class="quest-generate-field">
                                                <label>Enemies</label>
                                                <input type="text" id="questGenerateEnemyFilter" class="quest-generate-filter" placeholder="Search enemies...">
                                                <select id="questGenerateEnemies" multiple></select>
                                            </div>
                                            <div class="quest-generate-field">
                                                <label>Relevant Quests</label>
                                                <input type="text" id="questGenerateQuestFilter" class="quest-generate-filter" placeholder="Search quests...">
                                                <select id="questGenerateQuests" multiple></select>
                                            </div>
                                        </div>

                                        <div class="quest-generate-section">
                                            <h4>Rewards</h4>
                                            <div class="quest-generate-row">
                                                <div class="quest-generate-field">
                                                    <label>Item Rewards</label>
                                                    <input type="text" id="questGenerateItemRewardFilter" class="quest-generate-filter" placeholder="Search items...">
                                                    <select id="questGenerateRewardItems" multiple></select>
                                                </div>
                                                <div class="quest-generate-field">
                                                    <label>Perk Rewards</label>
                                                    <input type="text" id="questGeneratePerkRewardFilter" class="quest-generate-filter" placeholder="Search perks...">
                                                    <select id="questGenerateRewardPerks" multiple></select>
                                                </div>
                                                <div class="quest-generate-field">
                                                    <label>Potion Rewards</label>
                                                    <input type="text" id="questGeneratePotionRewardFilter" class="quest-generate-filter" placeholder="Search potions...">
                                                    <select id="questGenerateRewardPotions" multiple></select>
                                                </div>
                                                <div class="quest-generate-field">
                                                    <label>Blessing Rewards</label>
                                                    <input type="text" id="questGenerateBlessingRewardFilter" class="quest-generate-filter" placeholder="Search blessings...">
                                                    <select id="questGenerateRewardBlessings" multiple></select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="generate-right">
                                        <div class="quest-generate-field generate-prompt">
                                            <label>Prompt</label>
                                            <textarea id="questGeneratePrompt" placeholder="What kind of quest do you want?"></textarea>
                                        </div>
                                        <div class="quest-generate-actions">
                                            <div id="questGenerateStatus" class="generate-status" style="display:none;">
                                                <span class="loading"></span>
                                                <span class="generate-status-text">Generating...</span>
                                            </div>
                                            <button id="questGenerateRun" class="btn-primary">Generate</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- New Quest Modal -->
            <div id="newQuestModal" class="quest-modal">
                <div class="quest-modal-content">
                    <h3>Create New Quest</h3>
                    <div>
                        <label>Quest Name:</label>
                        <input type="text" id="newQuestName" placeholder="Enter quest name...">
                    </div>
                    <div class="quest-modal-actions">
                        <button class="btn-cancel" onclick="window.closeNewQuestModal()">Cancel</button>
                        <button class="btn-save" onclick="window.createNewQuest()">Create</button>
                    </div>
                </div>
            </div>
            
            <!-- Quest Asset Gallery Overlay -->
            <div id="questAssetGalleryOverlay" class="quest-asset-gallery-overlay">
                <div class="quest-asset-gallery-modal">
                    <div class="quest-asset-gallery-header">
                        <h3>Select Quest Background</h3>
                        <div class="asset-gallery-filter">
                            <input type="text" id="questAssetFilter" placeholder="Filter by location name..." autocomplete="off">
                        </div>
                        <button id="questGalleryClose" class="quest-asset-gallery-close" onclick="window.closeQuestAssetModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="quest-asset-gallery-content">
                        <div id="questAssetGallery" class="quest-asset-grid">
                            <!-- Assets will be populated here -->
                        </div>
                    </div>
                    <div class="quest-upload-section">
                        <button id="questUploadBtn" class="btn-upload-asset">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            Upload New Asset
                        </button>
                        <input type="file" id="questAssetFileInput" accept="image/*" style="display: none;">
                        <span id="questAssetUploadStatus" class="quest-upload-status"></span>
                    </div>
                </div>
            </div>

            <!-- Quest Preview Overlay -->
            <div id="questPreviewOverlay" class="quest-preview-overlay" aria-hidden="true">
                <div class="quest-preview-card">
                    <div class="quest-preview-header">
                        <div class="quest-preview-heading">
                            <p class="quest-preview-label">Quest Preview</p>
                        </div>
                        <div class="quest-preview-header-actions">
                            <button id="questPreviewReset" class="btn-secondary" type="button">Reset</button>
                            <button id="questPreviewClose" class="quest-preview-close" type="button">‚úï</button>
                        </div>
                    </div>
                        <div class="quest-preview-scene" id="questPreviewScene">
                        <div class="quest-preview-scene-mask"></div>
                        <div class="quest-preview-scene-content">
                            <div id="questPreviewText" class="quest-preview-text"></div>
                            <div id="questPreviewReward" class="quest-preview-reward" style="display:none;"></div>
                            <div id="questPreviewOptions" class="quest-preview-options"></div>
                        </div>
                    </div>
                    <div class="quest-preview-footer">
                        <button id="questPreviewBack" class="btn-secondary" type="button">‚Üê Back</button>
                        <p id="questPreviewStatus" class="quest-preview-status"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enemy Designer Section -->
        <div id="enemies-content" class="page-content" style="display: none;">
            <div class="enemy-designer-container">
                <!-- Left Sidebar - Enemy Lists -->
                <div class="enemy-list-sidebar">
                    <div class="enemy-list-controls">
                        <div class="enemy-tab-toggle">
                            <button type="button" id="gameEnemiesTab" class="tab-btn active">üéÆ Game</button>
                            <button type="button" id="pendingEnemiesTab" class="tab-btn">‚è≥ Pending</button>
                        </div>
                        <input type="text" id="enemySearch" placeholder="Search enemies...">
                        <button type="button" id="newEnemyBtn" class="btn-new">+ New Enemy</button>
                        <button type="button" id="mergeEnemiesBtn" class="btn-merge" style="display: none;">üîÄ Merge Approved</button>
                    </div>
                    <div id="enemyList" class="enemy-list"></div>
                    <div id="pendingEnemyList" class="enemy-list" style="display: none;"></div>
                </div>

                <!-- Main Content - Enemy Form -->
                <div class="enemy-form-container">
                    <form id="enemyForm">
                        <!-- Top Row: Icon + Name/ID + Stats unified -->
                        <div class="enemy-unified-form">
                            <div class="enemy-header">
                                <!-- Icon -->
                                <div class="enemy-icon-column">
                                    <div class="enemy-icon-box" id="enemyIconUploadArea">
                                        <div class="enemy-icon-preview" id="enemyIconPreview">
                                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                                <polyline points="17 8 12 3 7 8"/>
                                                <line x1="12" y1="3" x2="12" y2="15"/>
                                            </svg>
                                            <span>Click to select</span>
                                        </div>
                                    </div>
                                    <input type="file" id="enemyIconFile" accept="image/*" style="display: none;">
                                    <button type="button" id="enemyAssetGalleryBtn" style="display:none;"></button>
                                </div>

                                <!-- Name & ID + Stats -->
                                <div class="enemy-info">
                                    <input type="hidden" id="enemyId" value="">
                                    <div class="enemy-row">
                                        <div class="enemy-field enemy-field-grow"><label>Name</label><input type="text" id="enemyName" required placeholder="Enemy name..."></div>
                                    </div>
                                    <div class="enemy-stats-grid">
                                        <div class="stat-row"><label>Strength</label><input type="number" id="enemyStrength" min="0" max="999" value="0"></div>
                                        <div class="stat-row"><label>Stamina</label><input type="number" id="enemyStamina" min="0" max="999" value="0"></div>
                                        <div class="stat-row"><label>Agility</label><input type="number" id="enemyAgility" min="0" max="999" value="0"></div>
                                        <div class="stat-row"><label>Luck</label><input type="number" id="enemyLuck" min="0" max="999" value="0"></div>
                                        <div class="stat-row"><label>Armor</label><input type="number" id="enemyArmor" min="0" max="999" value="0"></div>
                                        <div class="stat-row damage-row">
                                            <label>Damage</label>
                                            <div class="damage-inputs">
                                                <input type="number" id="enemyMinDamage" min="0" max="999" value="0" placeholder="Min">
                                                <span>-</span>
                                                <input type="number" id="enemyMaxDamage" min="0" max="999" value="0" placeholder="Max">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="enemy-description-row">
                                <label for="enemyDescription">Description</label>
                                <textarea id="enemyDescription" rows="2" placeholder="Enemy description..."></textarea>
                            </div>
                        </div>

                        <!-- Talent Tree -->
                        <div class="enemy-talent-section">
                            <h3>Talent Tree <span class="talent-hint">(Click to upgrade)</span></h3>
                            <div id="talentTreeGrid" class="talent-tree-grid">
                                <!-- 7x8 grid will be populated by JS -->
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="enemy-form-actions">
                            <button type="button" id="enemyCancelBtn" class="btn-cancel">Cancel</button>
                            <button type="submit" id="enemySaveBtn" class="btn-save" disabled>üíæ Save to Pending</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Enemy Asset Gallery Overlay -->
            <div id="enemyAssetGalleryOverlay" class="asset-gallery-overlay" style="display: none;">
                <div class="asset-gallery">
                    <div class="asset-gallery-header">
                        <h3>Enemy Assets</h3>
                        <div class="gallery-header-actions">
                            <button type="button" id="enemyUploadNewBtn" class="gallery-upload-btn">Upload</button>
                            <button type="button" id="enemyAssetGalleryClose" class="btn-close">‚úï</button>
                        </div>
                    </div>
                    <div id="enemyAssetGrid" class="asset-gallery-grid"></div>
                </div>
            </div>
        </div>

        <!-- Talent Editor Section -->
        <div id="talents-content" class="page-content" style="display: none;">
            <div class="talent-designer-container">
                <div class="talent-grid-panel">
                    <div id="talentGrid" class="talent-grid">
                        <!-- 7x8 grid will be populated by JS -->
                    </div>
                </div>

                <div class="talent-editor-panel">
                    <div class="talent-editor-header">
                        <h3>Talent Editor</h3>
                    </div>
                    <div id="talentEditorEmpty" class="talent-editor-empty">
                        Select a talent to edit its settings.
                    </div>
                    <form id="talentEditorForm" class="talent-editor-form" style="display: none;">
                        <input type="hidden" id="talentId">
                        <input type="hidden" id="talentAssetId" value="1">
                        <input type="file" id="talentAssetFile" accept="image/*" style="display: none;">

                        <!-- Icon + Name/Max row -->
                        <div class="talent-header-row">
                            <div class="talent-icon-column">
                                <div class="talent-asset-preview" id="talentAssetPreview" onclick="toggleTalentAssetGallery()">
                                    <img id="talentAssetImage" src="" alt="No asset">
                                    <span id="talentAssetPlaceholder">Click to<br>select icon</span>
                                </div>

                            </div>
                            <div class="talent-info-fields">
                                <div class="talent-form-row">
                                    <label>Talent Name</label>
                                    <input type="text" id="talentName" required>
                                </div>
                                <div class="talent-form-row">
                                    <label>Max Points</label>
                                    <input type="number" id="talentMaxPoints" min="1" max="20" required>
                                </div>
                                <div class="talent-form-row perk-row">
                                    <label for="talentPerkSlot">Perk Slot</label>
                                    <div class="talent-checkbox">
                                        <input type="checkbox" id="talentPerkSlot">
                                        <span>Enabled</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Effect + Factor side by side -->
                        <div class="talent-effect-row">
                            <div class="talent-form-row talent-effect-field">
                                <label>Effect</label>
                                <select id="talentEffectId">
                                    <option value="">-- No Effect --</option>
                                </select>
                            </div>
                            <div class="talent-form-row talent-factor-field">
                                <label>Factor</label>
                                <input type="number" id="talentFactor" placeholder="e.g. 5">
                            </div>
                        </div>
                        <div id="talentEffectDescription" class="talent-effect-description"></div>

                        <!-- Description -->
                        <div class="talent-form-row">
                            <label>Description</label>
                            <textarea id="talentDescription" rows="4" placeholder="Talent description..."></textarea>
                        </div>

                        <!-- Actions -->
                        <div class="talent-form-actions">
                            <span id="talentEditorStatus" class="talent-editor-status"></span>
                            <button type="button" id="talentResetBtn" class="btn-cancel">Reset</button>
                            <button type="button" id="talentSaveBtn" class="btn-save" disabled>Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Talent Asset Gallery Overlay -->
            <div id="talentAssetGalleryOverlay" class="talent-asset-gallery-overlay hidden">
                <div class="talent-asset-gallery">
                    <div class="talent-asset-gallery-header">
                        <h3>Talent Assets</h3>
                        <div class="gallery-header-actions">
                            <button type="button" id="talentUploadNewBtn" class="gallery-upload-btn">Upload</button>
                            <button type="button" id="talentAssetGalleryClose" class="talent-asset-gallery-close">‚úï</button>
                        </div>
                    </div>
                    <div id="talentAssetGrid" class="talent-asset-grid"></div>
                </div>
            </div>
        </div>

        <!-- Item Designer Section -->
        <div id="items-content" class="page-content" style="display: none;">
            <div class="items-designer-container">
                <!-- Left Sidebar - Item Lists -->
                <div class="item-list-sidebar">
                    <div class="item-list-controls">
                        <div class="item-tab-toggle">
                            <button type="button" id="gameItemsTab" class="tab-btn active">üéÆ Game Items</button>
                            <button type="button" id="pendingItemsTab" class="tab-btn">‚è≥ Pending</button>
                        </div>
                        <input type="text" id="itemSearch" placeholder="Search items...">
                        <select id="itemTypeFilter">
                            <option value="">All Types</option>
                            <option value="head">Head</option>
                            <option value="chest">Chest</option>
                            <option value="hands">Hands</option>
                            <option value="feet">Feet</option>
                            <option value="belt">Belt</option>
                            <option value="legs">Legs</option>
                            <option value="back">Back</option>
                            <option value="amulet">Amulet</option>
                            <option value="weapon">Weapon</option>
                            <option value="hammer">Hammer</option>
                            <option value="gem">Gem</option>
                            <option value="scroll">Scroll</option>
                            <option value="potion">Potion</option>
                            <option value="ingredient">Ingredient</option>
                            <option value="ration">Ration</option>
                        </select>
                    </div>
                    
                    <!-- Item List (shows either game or pending based on tab) -->
                    <div id="itemListContainer" class="item-list-container">
                        <div id="itemList"></div>
                        <div id="pendingItemList" style="display: none;"></div>
                    </div>
                    
                    <div class="item-list-buttons">
                        <button type="button" id="newItemBtn">+ New Item</button>
                        <button type="button" id="mergeItemsBtn" class="btn-merge" style="display: none;">üîÑ Merge Approved</button>
                    </div>
                </div>

                <!-- Right Panel - Item Editor -->
                <div class="item-editor-panel">
                    <h2 id="itemEditorTitle">Create New Item</h2>
                    
                    <form id="itemForm">
                        <input type="hidden" id="itemId">
                        <input type="hidden" id="itemAssetID" value="1">

                        <div class="item-unified-form">
                            <!-- Icon + Basic Info -->
                            <div class="item-header">
                                <div class="item-icon-column">
                                    <div class="item-icon-box" id="itemIconUploadArea">
                                        <img id="itemIconPreview" src="" alt="">
                                        <span id="itemIconPlaceholder">Click to select icon</span>
                                    </div>
                                    <input type="file" id="itemIconFile" accept="image/*" style="display: none;">
                                    <input type="hidden" id="itemAssetID" value="1">
                                    <button type="button" id="itemAssetGalleryBtn" style="display:none;"></button>
                                </div>
                                <div class="item-info">
                                    <div class="item-row">
                                        <div class="item-field item-field-grow"><label>Name</label><input type="text" id="itemName" placeholder="Item name" required></div>
                                        <div class="item-field item-field-small"><label>Silver</label><input type="number" id="itemSilver" value="10" min="0" max="9999"></div>
                                        <div class="item-field item-field-small"><label>Type</label>
                                            <select id="itemType" required>
                                                <option value="">Select</option>
                                                <option value="head">Head</option>
                                                <option value="chest">Chest</option>
                                                <option value="hands">Hands</option>
                                                <option value="feet">Feet</option>
                                                <option value="belt">Belt</option>
                                                <option value="legs">Legs</option>
                                                <option value="back">Back</option>
                                                <option value="amulet">Amulet</option>
                                                <option value="weapon">Weapon</option>
                                                <option value="hammer">Hammer</option>
                                                <option value="gem">Gem</option>
                                                <option value="scroll">Scroll</option>
                                                <option value="potion">Potion</option>
                                                <option value="ingredient">Ingredient</option>
                                                <option value="ration">Ration</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="item-row">
                                        <div class="item-field item-field-full"><label>Description</label><textarea id="itemNotes" rows="3" placeholder="Short description..."></textarea></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stats -->
                            <div class="item-stats-section">
                                <div class="item-stats-grid">
                                    <div class="stat-row"><label>Strength</label><input type="number" id="itemStrength" min="0" max="999" placeholder="0"></div>
                                    <div class="stat-row"><label>Stamina</label><input type="number" id="itemStamina" min="0" max="999" placeholder="0"></div>
                                    <div class="stat-row"><label>Agility</label><input type="number" id="itemAgility" min="0" max="999" placeholder="0"></div>
                                    <div class="stat-row"><label>Luck</label><input type="number" id="itemLuck" min="0" max="999" placeholder="0"></div>
                                    <div class="stat-row"><label>Armor</label><input type="number" id="itemArmor" min="0" max="999" placeholder="0"></div>
                                    <div class="stat-row socket-row"><label>Socket</label><input type="checkbox" id="itemSocket"></div>
                                </div>
                                <div id="weaponStatsSection" class="weapon-damage-row">
                                    <label>Damage</label>
                                    <div class="weapon-damage-inputs">
                                        <input type="number" id="itemMinDamage" min="0" max="999" placeholder="Min">
                                        <span>-</span>
                                        <input type="number" id="itemMaxDamage" min="0" max="999" placeholder="Max">
                                    </div>
                                </div>
                            </div>

                            <!-- Effect -->
                            <div class="item-effect-section">
                                <div class="item-row">
                                    <div class="item-field item-field-grow"><label>Effect</label><select id="itemEffect"><option value="">-- None --</option></select></div>
                                    <div class="item-field item-field-small"><label>Factor</label><input type="number" id="itemEffectFactor" placeholder="0" max="999"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="item-form-buttons">
                            <button type="button" id="itemCancelBtn" class="btn-cancel-item">Cancel</button>
                            <button type="submit" class="btn-save-item" disabled>Save Item</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Item Asset Gallery Overlay -->
            <div id="itemAssetGalleryOverlay" class="item-asset-gallery-overlay hidden">
                <div class="item-asset-gallery">
                    <div class="item-asset-gallery-header">
                        <h3>Select Item Asset</h3>
                        <div class="gallery-header-actions">
                            <button type="button" id="itemUploadNewBtn" class="gallery-upload-btn">Upload</button>
                            <button type="button" id="itemAssetGalleryClose" class="asset-gallery-close">‚úï</button>
                        </div>
                    </div>
                    <div id="itemAssetGrid" class="item-asset-grid custom-scrollbar">
                        <!-- Asset items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Perk Designer Section -->
        <div id="perks-content" class="page-content" style="display: none;">
            <div class="perks-designer-container">
                <!-- Left Sidebar - Perk Lists -->
                <div class="perk-list-sidebar">
                    <div class="perk-list-controls">
                        <div class="perk-tab-toggle">
                            <button type="button" id="gamePerksTab" class="tab-btn active">üéÆ Game Perks</button>
                            <button type="button" id="pendingPerksTab" class="tab-btn">‚è≥ Pending</button>
                        </div>
                        <input type="text" id="perkSearch" placeholder="Search perks...">
                    </div>
                    
                    <!-- Perk List (shows either game or pending based on tab) -->
                    <div id="perkListContainer" class="perk-list-container">
                        <div id="perkList"></div>
                        <div id="pendingPerkList" style="display: none;"></div>
                    </div>
                    
                    <div class="perk-list-buttons">
                        <button type="button" id="newPerkBtn">+ New Perk</button>
                        <button type="button" id="mergePerksBtn" class="btn-merge" style="display: none;">üîÑ Merge Approved</button>
                    </div>
                </div>

                <!-- Right Panel - Perk Editor -->
                <div class="perk-editor-panel">
                    <h2 id="perkEditorTitle">Create New Perk</h2>
                    
                    <form id="perkForm">
                        <input type="hidden" id="perkId">
                        <input type="hidden" id="perkAssetID" value="1">

                        <div class="perk-unified-form">
                            <!-- Icon + Basic Info -->
                            <div class="perk-header">
                                <div class="perk-icon-column">
                                    <div class="perk-icon-box" id="perkIconUploadArea">
                                        <img id="perkIconPreview" src="" alt="">
                                        <span id="perkIconPlaceholder">Click to select icon</span>
                                    </div>
                                    <input type="file" id="perkIconFile" accept="image/*" style="display: none;">
                                    <button type="button" id="perkAssetGalleryBtn" style="display:none;"></button>
                                </div>
                                <div class="perk-info">
                                    <div class="perk-row">
                                        <div class="perk-field perk-field-grow"><label>Name</label><input type="text" id="perkName" placeholder="Perk name" required></div>
                                        <div class="perk-field perk-field-small">
                                            <label class="perk-blessing-label">
                                                <input type="checkbox" id="perkIsBlessing">
                                                <span>‚≠ê Blessing</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="perk-row">
                                        <div class="perk-field perk-field-full"><label>Description</label><textarea id="perkDescription" rows="3" placeholder="Perk description..."></textarea></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Effects -->
                            <div class="perk-effects-section">
                                <div class="perk-effects-grid">
                                    <div class="perk-effect-row">
                                        <div class="perk-field perk-field-grow"><label>Effect 1</label><select id="perkEffect1"><option value="">-- None --</option></select></div>
                                        <div class="perk-field perk-field-small"><label>Factor</label><input type="number" id="perkFactor1" placeholder="0" max="999"></div>
                                    </div>
                                    <span class="perk-effect-desc" id="perkEffect1Desc">Select an effect to see description</span>
                                    <div class="perk-effect-row">
                                        <div class="perk-field perk-field-grow"><label>Effect 2</label><select id="perkEffect2"><option value="">-- None --</option></select></div>
                                        <div class="perk-field perk-field-small"><label>Factor</label><input type="number" id="perkFactor2" placeholder="0" max="999"></div>
                                    </div>
                                    <span class="perk-effect-desc" id="perkEffect2Desc">Select an effect to see description</span>
                                </div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="perk-form-buttons">
                            <button type="button" id="perkCancelBtn" class="btn-cancel-perk">Cancel</button>
                            <button type="submit" class="btn-save-perk" disabled>Save Perk</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Perk Asset Gallery Overlay -->
            <div id="perkAssetGalleryOverlay" class="perk-asset-gallery-overlay hidden">
                <div class="perk-asset-gallery">
                    <div class="perk-asset-gallery-header">
                        <h3>Select Perk Asset</h3>
                        <button type="button" id="perkAssetGalleryClose" class="perk-asset-gallery-close">‚úï</button>
                    </div>
                    <div id="perkAssetGrid" class="perk-asset-grid custom-scrollbar">
                        <!-- Asset items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Expedition Designer Section -->
        <div id="dungeons-content" class="page-content" style="display: none;">
            <div class="expedition-designer-container">
                <!-- Toolbar -->
                <div class="expedition-toolbar">
                    <div class="toolbar-left">
                        <div class="expedition-settlement-select">
                            <label>Settlement:</label>
                            <select id="expeditionSettlementSelect" onchange="window.onExpeditionSettlementChange && window.onExpeditionSettlementChange()">
                            </select>
                        </div>
                        <span id="slideCounter">0 slides</span>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <button id="zoomOutBtn" class="zoom-btn" title="Zoom Out" onclick="window.changeZoom(-0.1)">‚àí</button>
                            <span id="zoomIndicator" class="zoom-indicator">100%</span>
                            <button id="zoomInBtn" class="zoom-btn" title="Zoom In" onclick="window.changeZoom(0.1)">+</button>
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <button id="addSlideBtn" class="btn-primary">+ Add Slide</button>
                        <button id="expeditionGenerateBtn" class="btn-secondary">üß† Generate Cluster</button>
                        <button id="expeditionPreviewToggle" class="btn-secondary" type="button">‚ñ∂ Preview</button>
                        <button id="saveExpeditionBtn" class="btn-success" onclick="window.saveExpedition()">üíæ Save</button>
                        <button id="mergeExpeditionBtn" class="btn-publish" onclick="window.mergeExpedition()">üöÄ Publish to Game</button>
                    </div>
                </div>
                <div id="expeditionPreviewOverlay" class="quest-preview-overlay" aria-hidden="true">
                    <div class="quest-preview-card">
                        <div class="quest-preview-header">
                            <div class="quest-preview-heading">
                                <p class="quest-preview-label">Expedition Preview</p>
                                <h3 id="expeditionPreviewTitle">Slide</h3>
                            </div>
                            <div class="quest-preview-header-actions">
                                <button id="expeditionPreviewReset" class="btn-secondary" type="button">Reset</button>
                                <button id="expeditionPreviewClose" class="quest-preview-close" type="button">‚úï</button>
                            </div>
                        </div>
                        <div class="quest-preview-scene" id="expeditionPreviewScene">
                            <div class="quest-preview-scene-mask"></div>
                            <div class="quest-preview-scene-content">
                                <div id="expeditionPreviewText" class="quest-preview-text"></div>
                                <div id="expeditionPreviewReward" class="quest-preview-reward" style="display:none;"></div>
                                <div id="expeditionPreviewOptions" class="quest-preview-options"></div>
                            </div>
                        </div>
                        <div class="quest-preview-footer">
                            <button id="expeditionPreviewBack" class="btn-secondary" type="button">‚Üê Back</button>
                            <p id="expeditionPreviewStatus" class="quest-preview-status"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Canvas -->
                <div id="expeditionCanvas" class="expedition-canvas">
                    <svg id="connectionsSvg" class="connections-svg">
                        <path id="connectionPreview" class="connection-preview" style="display:none"></path>
                    </svg>
                    <div id="slidesContainer" class="slides-container"></div>
                    
                    <!-- Navigation Controls -->
                    <div class="canvas-nav-controls">
                        <button class="nav-btn" onclick="window.panCanvas(0, 100)" title="Pan Up">‚ñ≤</button>
                        <div class="nav-row">
                            <button class="nav-btn" onclick="window.panCanvas(100, 0)" title="Pan Left">‚óÄ</button>
                            <button class="nav-btn nav-center" onclick="window.centerCanvas()" title="Center">‚äô</button>
                            <button class="nav-btn" onclick="window.panCanvas(-100, 0)" title="Pan Right">‚ñ∂</button>
                        </div>
                        <button class="nav-btn" onclick="window.panCanvas(0, -100)" title="Pan Down">‚ñº</button>
                    </div>
                </div>
                
                <div id="expeditionGenerateOverlay" class="generate-overlay" style="display:none;">
                    <div id="expeditionGeneratePanel" class="generate-modal expedition-generate-sidebar">
                        <div class="quest-generate-header">
                            <h3>üß† Generate Cluster</h3>
                            <button id="expeditionGenerateClose" class="btn-secondary">Close</button>
                        </div>
                        <div class="quest-generate-body">
                            <div class="generate-columns">
                                <div class="generate-left">
                                    <div class="quest-generate-field">
                                        <label>Location</label>
                                        <input type="text" id="expeditionGenerateLocationFilter" class="quest-generate-filter" placeholder="Search locations...">
                                        <select id="expeditionGenerateLocation"></select>
                                    </div>
                                    <div class="quest-generate-row">
                                        <div class="quest-generate-field">
                                            <label>NPCs</label>
                                            <input type="text" id="expeditionGenerateNpcFilter" class="quest-generate-filter" placeholder="Search NPCs...">
                                            <select id="expeditionGenerateNpcs" multiple></select>
                                        </div>
                                        <div class="quest-generate-field">
                                            <label>Enemies</label>
                                            <input type="text" id="expeditionGenerateEnemyFilter" class="quest-generate-filter" placeholder="Search enemies...">
                                            <select id="expeditionGenerateEnemies" multiple></select>
                                        </div>
                                    </div>
                                    <div class="quest-generate-section">
                                        <h4>Rewards</h4>
                                        <div class="quest-generate-row">
                                            <div class="quest-generate-field">
                                                <label>Item Rewards</label>
                                                <input type="text" id="expeditionGenerateItemRewardFilter" class="quest-generate-filter" placeholder="Search items...">
                                                <select id="expeditionGenerateRewardItems" multiple></select>
                                            </div>
                                            <div class="quest-generate-field">
                                                <label>Perk Rewards</label>
                                                <input type="text" id="expeditionGeneratePerkRewardFilter" class="quest-generate-filter" placeholder="Search perks...">
                                                <select id="expeditionGenerateRewardPerks" multiple></select>
                                            </div>
                                            <div class="quest-generate-field">
                                                <label>Potion Rewards</label>
                                                <input type="text" id="expeditionGeneratePotionRewardFilter" class="quest-generate-filter" placeholder="Search potions...">
                                                <select id="expeditionGenerateRewardPotions" multiple></select>
                                            </div>
                                            <div class="quest-generate-field">
                                                <label>Blessing Rewards</label>
                                                <input type="text" id="expeditionGenerateBlessingRewardFilter" class="quest-generate-filter" placeholder="Search blessings...">
                                                <select id="expeditionGenerateRewardBlessings" multiple></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="generate-right">
                                    <div class="quest-generate-field generate-prompt">
                                        <label>Prompt</label>
                                        <textarea id="expeditionGeneratePrompt" placeholder="What kind of expedition cluster do you want?"></textarea>
                                    </div>
                                    <div class="quest-generate-actions">
                                        <div id="expeditionGenerateStatus" class="generate-status" style="display:none;">
                                            <span class="loading"></span>
                                            <span class="generate-status-text">Preparing...</span>
                                        </div>
                                        <button id="expeditionGenerateRun" class="btn-primary">Generate</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Option Modal -->
            <div id="optionModal" class="option-modal">
                <div class="option-modal-content">
                    <h3 id="optionModalTitle">Add Option</h3>
                    <div class="modal-field">
                        <label>Option Text</label>
                        <input type="text" id="optionModalText" placeholder="Enter option text...">
                    </div>
                    <div class="modal-field">
                        <label>Type</label>
                        <select id="optionModalType" onchange="window.updateOptionModalFields && window.updateOptionModalFields(this.value)">
                            <option value="dialogue">üí¨ Dialogue (no check)</option>
                            <option value="skill">üéØ Skill Check (stat requirement)</option>
                            <option value="effect">‚ú® Effect Check (effect requirement)</option>
                            <option value="combat">‚öîÔ∏è Combat (enemy encounter)</option>
                            <option value="faction">üõ°Ô∏è Faction Gate</option>
                            <option value="silver">ü™ô Silver Gate (cost)</option>
                        </select>
                    </div>
                    
                    <!-- Skill Check Fields -->
                    <div id="optionStatFields" class="modal-field-row" style="display:none;">
                        <div class="modal-field">
                            <label>Stat Type</label>
                            <select id="optionStatType">
                                <option value="">Select stat...</option>
                                <option value="strength">Strength</option>
                                <option value="agility">Agility</option>
                                <option value="stamina">Stamina</option>
                                <option value="luck">Luck</option>
                                <option value="armor">Armor</option>
                            </select>
                        </div>
                        <div class="modal-field">
                            <label>Required Amount</label>
                            <input type="number" id="optionStatRequired" placeholder="e.g. 50" min="1">
                        </div>
                    </div>
                    
                    <!-- Effect Check Fields -->
                    <div id="optionEffectFields" class="modal-field-row" style="display:none;">
                        <div class="modal-field">
                            <label>Effect</label>
                            <select id="optionEffectId">
                                <option value="">Select effect...</option>
                                <!-- Populated dynamically from global effects array -->
                            </select>
                        </div>
                        <div class="modal-field">
                            <label>Required Amount</label>
                            <input type="number" id="optionEffectAmount" placeholder="e.g. 10" min="1">
                        </div>
                    </div>
                    
                    <!-- Combat Fields -->
                    <div id="optionCombatFields" class="modal-field" style="display:none;">
                        <label>Select Enemy</label>
                        <input type="hidden" id="optionEnemyId" value="">
                        <div id="enemyPickerGrid" class="enemy-picker-grid">
                            <!-- Populated dynamically with enemy icons -->
                        </div>
                    </div>

                    <!-- Faction Fields -->
                    <div id="optionFactionFields" class="modal-field" style="display:none;">
                        <label>Required Faction</label>
                        <select id="optionFactionRequired">
                            <option value="">Select faction...</option>
                            <option value="order">Order</option>
                            <option value="guild">Guild</option>
                            <option value="companions">Companions</option>
                        </select>
                        <small style="color:#889;margin-top:6px;display:block;">Only members of this faction see the option.</small>
                    </div>

                    <!-- Silver Gate Fields -->
                    <div id="optionSilverFields" class="modal-field" style="display:none;">
                        <label>Silver Required</label>
                        <input type="number" id="optionSilverRequired" placeholder="e.g. 200" min="0" step="10">
                        <small style="color:#889;margin-top:6px;display:block;">Option stays hidden unless the player can spend this amount.</small>
                    </div>
                    
                    <div class="modal-buttons">
                        <button id="optionModalCancel" class="btn-cancel" onclick="window.closeOptionModal()">Cancel</button>
                        <button id="optionModalSave" class="btn-primary" onclick="window.saveOptionFromModal()">Save</button>
                    </div>
                </div>
            </div>
            
            <!-- Expedition Asset Gallery Overlay (same style as quest gallery) -->
            <div id="expeditionAssetGalleryOverlay" class="expedition-asset-gallery-overlay">
                <div class="expedition-asset-gallery-modal">
                    <div class="expedition-asset-gallery-header">
                        <h3>Select Slide Background</h3>
                        <div class="asset-gallery-filter">
                            <input type="text" id="expeditionAssetFilter" placeholder="Filter by location name..." autocomplete="off">
                        </div>
                        <button class="expedition-asset-gallery-close" onclick="window.closeExpeditionAssetGallery()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="expedition-asset-gallery-content">
                        <div id="expeditionAssetGallery" class="expedition-asset-grid">
                            <!-- Assets will be populated here -->
                        </div>
                    </div>
                    <div class="expedition-upload-section">
                        <button id="expeditionUploadBtn" class="btn-upload-asset">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            Upload New Asset
                        </button>
                        <input type="file" id="expeditionAssetFileInput" accept="image/*" style="display: none;">
                        <span id="expeditionAssetUploadStatus" class="expedition-upload-status"></span>
                    </div>
                </div>
            </div>
            
            <!-- Reward Modal -->
            <div id="rewardModal" class="option-modal">
                <div class="option-modal-content">
                    <h3>Slide Reward</h3>
                    <div class="modal-field">
                        <label>Reward Type</label>
                        <select id="rewardModalType" onchange="window.updateRewardModalFields && window.updateRewardModalFields(this.value)">
                            <option value="stat">üìä Stat Bonus</option>
                            <option value="talent">‚≠ê Talent Point</option>
                            <option value="item">üéí Item</option>
                            <option value="perk">üîÆ Perk</option>
                            <option value="blessing">‚ú® Blessing</option>
                            <option value="potion">üß™ Potion</option>
                            <option value="silver">ü™ô Silver</option>
                        </select>
                    </div>
                    
                    <!-- Stat Bonus Fields -->
                    <div id="rewardStatFields" class="modal-field">
                        <label>Stat Type</label>
                        <select id="rewardStatType">
                            <option value="strength">üí™ Strength</option>
                            <option value="stamina">‚ù§Ô∏è Stamina</option>
                            <option value="agility">üèÉ Agility</option>
                            <option value="luck">üçÄ Luck</option>
                            <option value="armor">üõ°Ô∏è Armor</option>
                        </select>
                        <label style="margin-top:8px;">Amount</label>
                        <input type="number" id="rewardStatAmount" value="1" min="1" max="100">
                    </div>
                    
                    <!-- Item Fields -->
                    <div id="rewardItemFields" class="modal-field" style="display:none;">
                        <label>Select Item</label>
                        <input type="hidden" id="rewardItemId" value="">
                        <div id="rewardItemPickerGrid" class="item-picker-grid">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                    
                    <!-- Perk Fields -->
                    <div id="rewardPerkFields" class="modal-field" style="display:none;">
                        <label>Select Perk</label>
                        <select id="rewardPerkId">
                            <option value="">-- Select a perk --</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    
                    <!-- Blessing Fields -->
                    <div id="rewardBlessingFields" class="modal-field" style="display:none;">
                        <label>Select Blessing</label>
                        <select id="rewardBlessingId">
                            <option value="">-- Select a blessing --</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    
                    <!-- Potion Fields -->
                    <div id="rewardPotionFields" class="modal-field" style="display:none;">
                        <label>Select Potion</label>
                        <input type="hidden" id="rewardPotionId" value="">
                        <div id="rewardPotionPickerGrid" class="item-picker-grid">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Silver Fields -->
                    <div id="rewardSilverFields" class="modal-field" style="display:none;">
                        <label>Silver Amount</label>
                        <input type="number" id="rewardSilverAmount" value="0" min="0" step="10" placeholder="e.g. 250">
                        <small style="color:#889;display:block;margin-top:6px;">Granted as pure currency instead of loot.</small>
                    </div>
                    
                    <div class="modal-buttons">
                        <button class="btn-cancel" onclick="window.closeRewardModal()">Cancel</button>
                        <button class="btn-primary" onclick="window.saveRewardFromModal()">Save Reward</button>
                    </div>
                </div>
            </div>
            
            <!-- Effect Modal (for slide effects) -->
            <div id="effectModal" class="option-modal">
                <div class="option-modal-content" style="max-width: 400px;">
                    <h3>Slide Effect</h3>
                    <p style="color: #888; font-size: 12px; margin-bottom: 15px;">
                        Effects are applied when a character enters this slide (e.g., health loss, stat debuffs).
                    </p>
                    <div class="modal-field">
                        <label>Effect Type</label>
                        <select id="slideEffectId">
                            <option value="">-- Select an effect --</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Factor (amount)</label>
                        <input type="number" id="slideEffectFactor" value="0" placeholder="e.g., -10 for health loss">
                        <small style="color: #888;">Negative values for penalties (e.g., -10 health), positive for buffs</small>
                    </div>
                    <div class="modal-buttons">
                        <button class="btn-cancel" onclick="window.closeEffectModal()">Cancel</button>
                        <button class="btn-primary" onclick="window.saveEffectFromModal()">Save Effect</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NPC Manager Section -->
        <div id="npcs-content" class="page-content" style="display: none;">
            <div class="npc-manager-container">
                <div class="npc-list-panel">
                    <div class="npc-list-header">
                        <h3>NPCs</h3>
                    </div>
                    <div class="npc-filters">
                        <input type="text" id="npcSearch" placeholder="Search by name..." autocomplete="off">
                        <select id="npcSettlementFilter">
                            <option value="">All Settlements</option>
                        </select>
                    </div>
                    <div class="npc-table-wrapper">
                        <table class="npc-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Settlement</th>
                                </tr>
                            </thead>
                            <tbody id="npcTableBody">
                                <tr><td colspan="3" class="npc-empty">No NPCs found</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="npc-editor-panel">
                    <div class="npc-editor-header">
                        <h3>NPC Editor</h3>
                        <span id="npcStatus" class="npc-status"></span>
                    </div>
                    <form id="npcForm" class="npc-form">
                        <input type="hidden" id="npcId">

                        <!-- Name + Settlement side by side -->
                        <div class="npc-row-2col">
                            <div class="npc-form-row">
                                <label>Name</label>
                                <input type="text" id="npcName" required>
                            </div>
                            <div class="npc-form-row">
                                <label>Settlement</label>
                                <select id="npcSettlementSelect">
                                    <option value="">-- None --</option>
                                </select>
                            </div>
                        </div>

                        <!-- Role + Personality side by side -->
                        <div class="npc-row-2col">
                            <div class="npc-form-row">
                                <label>Role</label>
                                <input type="text" id="npcRole" placeholder="Guard, merchant, barkeep...">
                            </div>
                            <div class="npc-form-row">
                                <label>Personality</label>
                                <textarea id="npcPersonality" rows="3" placeholder="Personality traits (one per line)..."></textarea>
                            </div>
                        </div>

                        <div class="npc-form-row">
                            <label>Context</label>
                            <textarea id="npcContext" rows="10" placeholder="NPC context..."></textarea>
                        </div>
                        <div class="npc-form-row">
                            <label>Goals</label>
                            <textarea id="npcGoals" rows="3" placeholder="Goals or motivations (one per line)..."></textarea>
                        </div>
                        <div class="npc-form-actions">
                            <button type="button" id="npcDeleteBtn" class="btn-delete" disabled>Delete</button>
                            <button type="button" onclick="createNewNpc()" class="btn-new-npc">+ New NPC</button>
                            <button type="submit" id="npcSaveBtn" class="btn-save" disabled>Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Settlement Designer Section -->
        <div id="settlements-content" class="page-content" style="display: none;">
            <div id="settlementDesigner" class="settlement-designer">
                <!-- Top bar with settlement selection -->
                <div class="settlement-top-bar">
                    <div class="settlement-select-wrapper">
                        <div class="settlement-select-group">
                            <label for="settlementSelect">Settlement:</label>
                            <select id="settlementSelect" class="settlement-select">
                                <option value="">-- New Settlement --</option>
                            </select>
                        </div>
                    </div>
                    <div class="settlement-top-actions">
                        <button id="saveSettlementBtn" class="btn-save-settlement">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Save
                        </button>
                        <button id="deleteSettlementBtn" class="btn-delete-settlement" style="display: none;">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>

                <!-- Cards container - Single row with all 5 cards -->
                <div class="settlement-cards-grid">
                    <!-- Settlement Card -->
                    <div class="settlement-card-wrapper">
                        <h3 class="settlement-card-title">Settlement</h3>
                        <div class="settlement-card">
                            <div id="settlementAssetArea" class="settlement-card-asset" data-asset-id="">
                                <div class="no-asset">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <span>Click to select asset</span>
                                </div>
                            </div>
                            <div class="settlement-card-info">
                                <div>
                                    <label for="settlementName">Name</label>
                                    <input type="text" id="settlementName" placeholder="Settlement name...">
                                </div>
                                <div>
                                    <label for="settlementDescription">Description</label>
                                    <textarea id="settlementDescription" placeholder="Settlement description..."></textarea>
                                </div>
                                <div>
                                    <label for="factionSelect">Faction</label>
                                    <select id="factionSelect" class="faction-select">
                                        <option value="">-- None --</option>
                                        <option value="1">Faction 1</option>
                                        <option value="2">Faction 2</option>
                                        <option value="3">Faction 3</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Arena Card -->
                    <div class="settlement-card-wrapper">
                        <h3 class="settlement-card-title">Arena</h3>
                        <div class="settlement-card">
                            <div id="arenaAssetArea" class="settlement-card-asset" data-asset-id="">
                                <div class="no-asset">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <span>Click to select asset</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Expedition Card -->
                    <div class="settlement-card-wrapper">
                        <h3 class="settlement-card-title">Expedition <button class="responses-btn" onclick="openResponsesModal('expedition')">üí¨</button></h3>
                        <div class="settlement-card">
                            <div id="expeditionAssetArea" class="settlement-card-asset" data-asset-id="">
                                <div class="no-asset">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <span>Click to select asset</span>
                                </div>
                            </div>
                            <div class="expedition-description-overlay">
                                <textarea id="expeditionDescription" placeholder="Enter expedition description..." class="expedition-textarea"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Vendor Card -->
                    <div class="settlement-card-wrapper">
                        <h3 class="settlement-card-title">Vendor <button class="responses-btn" onclick="openResponsesModal('vendor')">üí¨</button></h3>
                        <div class="settlement-card">
                            <div id="vendorAssetArea" class="settlement-card-asset" data-asset-id="">
                                <div class="no-asset">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <span>Click to select asset</span>
                                </div>
                            </div>
                            <div class="settlement-card-info">
                                <div class="vendor-items-section">
                                    <div class="section-header">
                                        <label>Items for Sale</label>
                                        <button id="addVendorItemBtn" class="add-inline-btn">+</button>
                                    </div>
                                    <div id="vendorItemsGrid" class="items-grid">
                                        <!-- Items will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Utility Card -->
                    <div class="settlement-card-wrapper">
                        <div class="utility-type-selector">
                            <div class="utility-type-row">
                                <select id="utilityTypeSelect">
                                    <option value="">-- Select Utility --</option>
                                    <option value="blacksmith">Blacksmith</option>
                                    <option value="alchemist">Alchemist</option>
                                    <option value="enchanter">Enchanter</option>
                                    <option value="trainer">Trainer</option>
                                    <option value="church">Church</option>
                                </select>
                                <button class="responses-btn" onclick="openResponsesModal('utility')">üí¨</button>
                            </div>
                        </div>
                        <div class="settlement-card">
                            <div id="utilityAssetArea" class="settlement-card-asset" data-asset-id="">
                                <div class="no-asset">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <span>Click to select asset</span>
                                </div>
                            </div>
                            <div class="settlement-card-info">
                                <!-- Church: Blessings -->
                                <div id="utilityChurchContent" class="utility-content">
                                    <label>Blessings (Perks)</label>
                                    <div class="blessing-selects">
                                        <select id="blessing1Select">
                                            <option value="">-- None --</option>
                                        </select>
                                        <select id="blessing2Select">
                                            <option value="">-- None --</option>
                                        </select>
                                        <select id="blessing3Select">
                                            <option value="">-- None --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Enchanter: Effects -->
                                <div id="utilityEnchanterContent" class="utility-content">
                                    <div class="section-header">
                                        <label>Available Effects</label>
                                        <button id="addEnchanterEffectBtn" class="add-inline-btn">+</button>
                                    </div>
                                    <div id="enchanterEffectsList" class="effects-list">
                                        <!-- Effects will be populated here -->
                                    </div>
                                </div>
                                
                                <!-- Blacksmith/Alchemist/Trainer: No extra content -->
                                <div id="utilityEmptyContent" class="utility-content">
                                    <p class="utility-empty-msg">No additional configuration needed</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settlement-context-section">
                    <div class="settlement-context-grid settlement-context-top">
                        <div>
                            <label for="settlementContext">Context</label>
                            <textarea id="settlementContext" placeholder="Long-form settlement context..."></textarea>
                        </div>
                        <div>
                            <label for="expeditionContext">Expedition Context</label>
                            <textarea id="expeditionContext" placeholder="Expedition-specific context..."></textarea>
                        </div>
                    </div>
                    <div class="settlement-context-grid settlement-context-bottom">
                        <div>
                            <label for="settlementKeyIssues">Key Issues</label>
                            <textarea id="settlementKeyIssues" placeholder="Key issues (one per line)..."></textarea>
                        </div>
                        <div>
                            <label for="settlementRecentEvents">Recent Events</label>
                            <textarea id="settlementRecentEvents" placeholder="Recent events (one per line)..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Locations Section -->
                <div class="settlement-locations-section">
                    <div class="locations-header">
                        <h3 class="locations-title">üìç Locations</h3>
                        <button id="addLocationBtn" class="btn-add-location">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Location
                        </button>
                    </div>
                    <div id="locationsGrid" class="locations-grid">
                        <!-- Location cards will be populated here -->
                        <div class="locations-empty-state" id="locationsEmptyState">
                            <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <p>No locations added yet</p>
                            <span>Click "Add Location" to create a new location for this settlement</span>
                        </div>
                    </div>
                </div>

                <!-- Location Edit Modal -->
                <div id="locationModalOverlay" class="location-modal-overlay">
                    <div class="location-modal">
                        <div class="location-modal-header">
                            <h3 id="locationModalTitle">Add Location</h3>
                            <button class="location-modal-close" onclick="closeLocationModal()">‚úï</button>
                        </div>
                        <div class="location-modal-content">
                            <div class="location-modal-grid">
                                <!-- Texture Preview (same aspect ratio as slides) -->
                                <div class="location-texture-section">
                                    <label>Texture</label>
                                    <div id="locationTextureArea" class="location-texture-preview" data-asset-id="">
                                        <div class="no-asset">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                                <polyline points="21 15 16 10 5 21"/>
                                            </svg>
                                            <span>Click to select texture</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Name and Description -->
                                <div class="location-info-section">
                                    <div class="location-field">
                                        <label for="locationName">Name</label>
                                        <input type="text" id="locationName" placeholder="Location name...">
                                    </div>
                                    <div class="location-field location-field-grow">
                                        <label for="locationDescription">Description</label>
                                        <textarea id="locationDescription" placeholder="Describe this location..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="location-modal-footer">
                            <button class="btn-cancel-location" onclick="closeLocationModal()">Cancel</button>
                            <button class="btn-save-location" onclick="saveLocation()">Save Location</button>
                        </div>
                    </div>
                </div>

                <!-- Responses Modal -->
                <div id="responsesModalOverlay" class="responses-modal-overlay">
                    <div class="responses-modal">
                        <div class="responses-modal-header">
                            <h3 id="responsesModalTitle">Vendor Responses</h3>
                            <button class="responses-modal-close" onclick="closeResponsesModal()">‚úï</button>
                        </div>
                        <div id="responsesModalContent" class="responses-modal-content">
                            <!-- Dynamic response entries -->
                        </div>
                        <div class="responses-modal-footer">
                            <button class="btn-add-response" onclick="addResponseEntry()">+ Add Response</button>
                            <button class="btn-save-responses" onclick="saveResponses()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- Asset Gallery Overlay -->
                <div id="settlementAssetGalleryOverlay" class="settlement-asset-gallery-overlay">
                    <div class="settlement-asset-gallery">
                        <div class="settlement-asset-gallery-header">
                            <h3 id="settlementGalleryTitle">Select Asset</h3>
                            <button id="settlementGalleryClose" class="settlement-asset-gallery-close">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="settlement-asset-gallery-content">
                            <div id="settlementAssetGrid" class="settlement-asset-grid">
                                <!-- Assets will be populated here -->
                            </div>
                        </div>
                        <div class="settlement-upload-section">
                            <button id="settlementUploadBtn" class="btn-upload-asset">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                Upload New Asset
                            </button>
                            <input type="file" id="settlementAssetFile" accept="image/*" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Management Section -->
        <div id="players-content" class="page-content" style="display: none;">
            <div class="tool-header">
                <div class="tool-icon">üë§</div>
                <h1>Player Management</h1>
                <p>Monitor player activity, handle reports, and manage user accounts.</p>
            </div>
        </div>

        <!-- Concept Section -->
        <div id="concept-content" class="page-content concept-page" style="display: none;">
            <div class="concept-container">
                <div class="concept-header">
                    <h2>üß≠ World Concept</h2>
                    <div class="concept-actions">
                        <span id="conceptStatus" class="concept-status"></span>
                        <button id="conceptSaveBtn" class="concept-save-btn">Save Changes</button>
                    </div>
                </div>

                <div class="concept-section">
                    <label for="conceptWildsPrompt">Wilds Prompt</label>
                    <textarea id="conceptWildsPrompt" placeholder="Enter wilds prompt..."></textarea>
                </div>

                <div class="concept-row">
                    <div class="concept-section concept-section-half">
                        <label for="conceptSystemPrompt">System Prompt</label>
                        <textarea id="conceptSystemPrompt" placeholder="Enter global system prompt..."></textarea>
                    </div>
                    <div class="concept-section concept-section-half">
                        <label for="conceptExpeditionClusterPrompt">Expedition Cluster Prompt</label>
                        <textarea id="conceptExpeditionClusterPrompt" placeholder="Enter expedition cluster system prompt..."></textarea>
                    </div>
                </div>

                <div class="concept-row">
                    <div class="concept-section concept-section-half">
                        <label for="conceptJson">Quest JSON</label>
                        <textarea id="conceptJson" placeholder="Enter quest JSON schema..."></textarea>
                    </div>
                    <div class="concept-section concept-section-half">
                        <label for="conceptExpeditionJson">Expedition JSON</label>
                        <textarea id="conceptExpeditionJson" placeholder="Enter expedition JSON schema..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Server Management Section -->
        <div id="servers-content" class="page-content" style="display: none;">
            <div class="server-manager-container">
                <div class="server-list-panel">
                    <div class="server-list-header">
                        <h3>Servers</h3>
                        <span id="serverStatus" class="server-status"></span>
                    </div>
                    <div class="server-table-wrapper">
                        <table class="server-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Starts</th>
                                    <th>Ends</th>
                                    <th>Characters</th>
                                    <th>Players</th>
                                    <th>Day</th>
                                </tr>
                            </thead>
                            <tbody id="serverTableBody">
                                <tr><td colspan="6" class="server-empty">No servers found</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="server-editor-panel">
                    <div class="server-editor-header">
                        <h3>Server Plan</h3>
                    </div>
                    <div id="serverPlanDetails" class="server-plan-details">
                        <div class="server-plan-empty">Select a server to view its world plan.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Moderation Section -->
        <div id="moderation-content" class="page-content" style="display: none;">
            <div class="moderation-layout">
                <div class="moderation-panel">
                    <div class="moderation-header">
                        <h3>Banned Words</h3>
                        <input type="text" id="bannedWordFilter" class="moderation-filter" placeholder="Filter words...">
                    </div>
                    <form id="bannedWordForm" class="moderation-add-row">
                        <input type="text" id="bannedWordInput" placeholder="Add banned word...">
                        <select id="bannedWordSeverity">
                            <option value="1" selected>Severity 1</option>
                            <option value="2">Severity 2</option>
                            <option value="3">Severity 3</option>
                            <option value="4">Severity 4</option>
                            <option value="5">Severity 5</option>
                        </select>
                        <button type="submit" class="btn-save">Add</button>
                    </form>
                    <div id="bannedWordStatus" class="moderation-status"></div>
                    <div class="moderation-list" id="bannedWordList"></div>
                </div>
                <div class="moderation-panel chat-panel">
                    <div class="moderation-header">
                        <h3>Live Chat</h3>
                        <span class="chat-subtitle">Active servers</span>
                    </div>
                    <div class="chat-server-select">
                        <label for="chatServerSelect">Channel</label>
                        <select id="chatServerSelect"></select>
                    </div>
                    <div class="chat-window">
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-empty">Chat stream will appear here.</div>
                        </div>
                        <div class="chat-input-row">
                            <input type="text" placeholder="Reply tools coming soon..." disabled>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Analytics Section -->
        <div id="analytics-content" class="page-content" style="display: none;">
            <div class="tool-header">
                <div class="tool-icon">üìä</div>
                <h1>Game Analytics</h1>
                <p>View detailed analytics about player behavior and game performance.</p>
            </div>
        </div>

        <!-- Asset Gallery Overlay -->
        <div id="assetGalleryOverlay" class="asset-gallery-overlay hidden">
            <div class="asset-gallery">
                <div class="asset-gallery-header">
                    <h3>Choose Existing Asset</h3>
                    <button type="button" class="close-gallery-btn" onclick="toggleAssetGallery()">‚úï</button>
                </div>
                <div class="asset-gallery-grid" id="assetGrid"></div>
            </div>
        </div>
    </div>    <!-- AWS Cognito SDK -->
    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>

    <script>
        // Function to get current access token from Cognito (same as in login.html)
        function getCurrentAccessToken() {
            try {
                const COGNITO_USER_POOL_ID = 'eu-north-1_il4Ww30RF';
                const COGNITO_CLIENT_ID = 'g7sjca510dnqgs2tldhgvbihj';
                const COGNITO_REGION = 'eu-north-1';

                const poolData = {
                    UserPoolId: COGNITO_USER_POOL_ID,
                    ClientId: COGNITO_CLIENT_ID,
                    region: COGNITO_REGION
                };

                const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
                const cognitoUser = userPool.getCurrentUser();

                if (cognitoUser != null) {
                    return new Promise((resolve, reject) => {
                        cognitoUser.getSession((err, session) => {
                            if (err) {
                                reject(err);
                                return;
                            }
                            if (session.isValid()) {
                                resolve(session.getAccessToken().getJwtToken());
                            } else {
                                resolve(null);
                            }
                        });
                    });
                }
                return Promise.resolve(null);
            } catch (error) {
                console.error('Error getting access token:', error);
                return Promise.resolve(null);
            }
        }

        // Simple logout function
        function logout() {
            console.log('Logout called');
            
            // Clear all Cognito-related tokens
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('CognitoIdentityServiceProvider')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                console.log('Removing Cognito key:', key);
                localStorage.removeItem(key);
            });
            
            console.log('Logout successful - redirecting to login');
            window.location.href = 'http://localhost:8080/login';
        }
        
        // Page navigation system
        const pages = {
            'dashboard': { title: 'Dashboard', element: 'dashboard-content' },
            'quests': { title: 'Quest Manager', element: 'quests-content' },
            'enemies': { title: 'Enemy Designer', element: 'enemies-content' },
            'talents': { title: 'Talent Editor', element: 'talents-content' },
            'items': { title: 'Item Designer', element: 'items-content' },
            'perks': { title: 'Perk Designer', element: 'perks-content' },
            'dungeons': { title: 'Expeditions', element: 'dungeons-content' },
            'settlements': { title: 'Settlement Designer', element: 'settlements-content' },
            'npcs': { title: 'NPC Manager', element: 'npcs-content' },
            'players': { title: 'Player Management', element: 'players-content' },
            'concept': { title: 'Concept', element: 'concept-content' },
            'servers': { title: 'Server Management', element: 'servers-content' },
            'moderation': { title: 'Chat Moderation', element: 'moderation-content' },
            'analytics': { title: 'Game Analytics', element: 'analytics-content' }
        };

        let currentPage = 'dashboard';

        function showPage(pageName) {
            const page = pages[pageName];
            if (!page) {
                console.error('Page not found:', pageName);
                return false;
            }

            console.log('Switching to page:', pageName);
            currentPage = pageName;

            // Hide all page content
            document.querySelectorAll('.page-content').forEach(content => {
                content.style.display = 'none';
            });

            // Show selected page content
            const targetElement = document.getElementById(page.element);
            if (targetElement) {
                targetElement.style.display = 'block';
                
                // If showing the talent editor, initialize once (init calls loadTalentEditorData internally)
                if (pageName === 'talents') {
                    if (window.initTalentDesigner && !window.talentDesignerInitialized) {
                        console.log('Initializing talent editor...');
                        window.initTalentDesigner();
                        window.talentDesignerInitialized = true;
                    }
                }

                // If showing the NPC manager, initialize once (init calls loadNpcData internally)
                if (pageName === 'npcs') {
                    if (window.initNpcManager && !window.npcManagerInitialized) {
                        console.log('Initializing NPC manager...');
                        window.initNpcManager();
                        window.npcManagerInitialized = true;
                    }
                }

                // If showing the server manager, initialize or reload
                if (pageName === 'servers') {
                    if (window.initServerManager && !window.serverManagerInitialized) {
                        console.log('Initializing server manager...');
                        window.initServerManager();
                        window.serverManagerInitialized = true;
                    }
                    if (window.loadServerData) {
                        window.loadServerData();
                    }
                }

                // If showing concept editor, initialize or reload
                if (pageName === 'concept') {
                    if (window.initConceptManager && !window.conceptManagerInitialized) {
                        console.log('Initializing concept editor...');
                        window.initConceptManager();
                        window.conceptManagerInitialized = true;
                    }
                    if (window.loadConceptData) {
                        window.loadConceptData();
                    }
                }

                // If showing chat moderation, initialize or reload
                if (pageName === 'moderation') {
                    if (window.initModerationManager && !window.moderationManagerInitialized) {
                        console.log('Initializing chat moderation...');
                        window.initModerationManager();
                        window.moderationManagerInitialized = true;
                    }
                    if (window.loadModerationData) {
                        window.loadModerationData();
                    }
                }
                
                // If showing the expedition designer, auto-load data
                if (pageName === 'dungeons') {
                    // Initialize expedition designer if not done yet
                    if (window.initExpeditionDesigner && !window.expeditionDesignerInitialized) {
                        console.log('Initializing expedition designer...');
                        window.initExpeditionDesigner();
                        window.expeditionDesignerInitialized = true;
                    }
                    // Load expedition data
                    if (window.loadExpedition) {
                        console.log('Auto-loading expedition data...');
                        window.loadExpedition();
                    }
                }
                
                // If showing the settlement designer, load data
                if (pageName === 'settlements' && window.loadSettlementDesignerData) {
                    window.loadSettlementDesignerData();
                }
                
                // If showing the quest designer, initialize and load data
                if (pageName === 'quests') {
                    if (window.initQuestDesigner && !window.questDesignerInitialized) {
                        console.log('Initializing quest designer...');
                        window.initQuestDesigner();
                        window.questDesignerInitialized = true;
                    }
                }
            } else {
                console.error('Element not found:', page.element);
                return false;
            }

            // Update header title
            const headerTitle = document.querySelector('.header h1');
            if (headerTitle) {
                headerTitle.textContent = page.title;
            }

            // Show/hide back button based on current page
            const backButton = document.getElementById('back-to-dashboard');
            if (backButton) {
                if (pageName === 'dashboard') {
                    backButton.style.display = 'none';
                } else {
                    backButton.style.display = 'inline-block';
                }
            }

            // Update URL without reload
            if (window.history && window.history.pushState) {
                window.history.pushState({page: pageName}, page.title, `#${pageName}`);
            }

            return false; // Prevent default behavior
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            const pageName = event.state?.page || 'dashboard';
            showPage(pageName);
        });

        // Prevent default link behavior for tool cards
        document.addEventListener('click', function(event) {
            if (event.target.closest('a[onclick]')) {
                event.preventDefault();
            }
        });
    </script>
    <script src="http://localhost:8080/static/global-data.js"></script>
    <script>
        (async function bootDashboard() {
            const overlay = document.getElementById('loading-overlay');
            const status = document.getElementById('loading-status');

            // 1. Preload all shared data first
            try {
                if (typeof preloadGlobalData === 'function') {
                    if (status) status.textContent = 'Fetching game data‚Ä¶';
                    await preloadGlobalData([
                        'settlements', 'settlementAssets', 'questAssets',
                        'items', 'perks', 'npcs',
                        'itemAssets', 'perkAssets', 'enemyAssets',
                        'effects', 'enemies'
                    ]);
                }
            } catch (e) {
                console.error('Global data preload failed', e);
            }

            // 2. Load designer scripts sequentially (order matters)
            if (status) status.textContent = 'Loading tools‚Ä¶';
            const scripts = [
                'designer-base.js',
                'enemy-designer-new.js',
                'talent-designer.js',
                'npc-designer.js',
                'server-designer.js',
                'chat-moderation.js',
                'item-designer.js',
                'perk-designer.js',
                'expedition-designer.js',
                'settlement-designer.js',
                'quest-designer.js',
                'concept-designer.js'
            ];
            for (const file of scripts) {
                await new Promise((resolve, reject) => {
                    const s = document.createElement('script');
                    s.src = 'http://localhost:8080/static/' + file;
                    s.onload = resolve;
                    s.onerror = () => { console.error('Failed to load ' + file); resolve(); };
                    document.body.appendChild(s);
                });
            }

            // 3. Hide loading overlay
            if (overlay) overlay.style.display = 'none';

            // 4. Navigate to the correct page (hash or dashboard)
            const hash = window.location.hash.substring(1);
            const initialPage = hash && typeof showPage === 'function' ? hash : 'dashboard';
            if (typeof showPage === 'function') showPage(initialPage);
        })();
    </script>
</body>
</html>