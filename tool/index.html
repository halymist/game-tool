<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="http://localhost:8080/static/shared-styles.css">
    <link rel="stylesheet" href="http://localhost:8080/static/enemy-designer-new.css">
    <link rel="stylesheet" href="http://localhost:8080/static/item-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/perk-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/expedition-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/settlement-designer.css">
    <link rel="stylesheet" href="http://localhost:8080/static/quest-designer.css">
    <!-- AWS Cognito SDK for token management -->
    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>Dashboard</h1>
            <button id="back-to-dashboard" onclick="showPage('dashboard'); return false;" class="back-btn" style="display: none;">‚Üê Back to Dashboard</button>
        </div>
        <div class="user-info">
            <span id="username-display">Admin User</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard-content" class="page-content">
            <!-- Creation Tools Section -->
            <div class="creation-tools">
                <h3 class="section-title">üõ†Ô∏è Creation Tools</h3>
                <div class="tools-grid">
                    <a href="#" onclick="showPage('quests'); return false;" class="tool-card">
                        <div class="tool-card-header">
                            <span class="tool-card-icon">üó°Ô∏è</span>
                            <h4 class="tool-card-title">Quest Manager</h4>
                        </div>
                        <div class="tool-card-body">
                            <p class="tool-card-description">Create and manage quests, objectives, and rewards for your players.</p>
                        </div>
                    </a>

                    <a href="#" onclick="showPage('enemies'); return false;" class="tool-card">
                        <div class="tool-card-header">
                            <span class="tool-card-icon">üëπ</span>
                            <h4 class="tool-card-title">Enemy Designer</h4>
                        </div>
                        <div class="tool-card-body">
                            <p class="tool-card-description">Design monsters, bosses, and enemy encounters for your game world.</p>
                        </div>
                    </a>

                    <a href="#" onclick="showPage('items'); return false;" class="tool-card">
                        <div class="tool-card-header">
                            <span class="tool-card-icon">‚öîÔ∏è</span>
                            <h4 class="tool-card-title">Item Designer</h4>
                        </div>
                        <div class="tool-card-body">
                            <p class="tool-card-description">Create weapons, armor, accessories, and other items for your game.</p>
                        </div>
                    </a>

                    <a href="#" onclick="showPage('perks'); return false;" class="tool-card">
                        <div class="tool-card-header">
                            <span class="tool-card-icon">‚ú®</span>
                            <h4 class="tool-card-title">Perk Designer</h4>
                        </div>
                        <div class="tool-card-body">
                            <p class="tool-card-description">Create and manage perks with effects for your game characters.</p>
                        </div>
                    </a>

                    <a href="#" onclick="showPage('dungeons'); return false;" class="tool-card">
                        <div class="tool-card-header">
                            <span class="tool-card-icon">üó∫Ô∏è</span>
                            <h4 class="tool-card-title">Expeditions</h4>
                        </div>
                        <div class="tool-card-body">
                            <p class="tool-card-description">Create branching expeditions with slides, options, and outcomes.</p>
                        </div>
                    </a>

                    <a href="#" onclick="showPage('settlements'); return false;" class="tool-card">
                        <div class="tool-card-header">
                            <span class="tool-card-icon">üèòÔ∏è</span>
                            <h4 class="tool-card-title">Settlement Designer</h4>
                        </div>
                        <div class="tool-card-body">
                            <p class="tool-card-description">Create and manage settlements with vendors and utilities.</p>
                        </div>
                    </a>

                    <a href="#" onclick="showPage('npcs'); return false;" class="tool-card">
                        <div class="tool-card-header">
                            <span class="tool-card-icon">üë•</span>
                            <h4 class="tool-card-title">NPC Manager</h4>
                        </div>
                        <div class="tool-card-body">
                            <p class="tool-card-description">Create NPCs, manage dialogues, and set up interactive characters.</p>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Management Tools Section -->
            <div class="management-tools">
                <h3 class="section-title">‚öôÔ∏è Management Tools</h3>
                <div class="tools-grid">
                    <a href="#" onclick="showPage('players'); return false;" class="tool-card">
                        <div class="tool-card-header">
                            <span class="tool-card-icon">üë§</span>
                            <h4 class="tool-card-title">Player Management</h4>
                        </div>
                        <div class="tool-card-body">
                            <p class="tool-card-description">Monitor player activity, handle reports, and manage user accounts.</p>
                        </div>
                    </a>

                    <a href="#" onclick="showPage('servers'); return false;" class="tool-card">
                        <div class="tool-card-header">
                            <span class="tool-card-icon">üñ•Ô∏è</span>
                            <h4 class="tool-card-title">Server Management</h4>
                        </div>
                        <div class="tool-card-body">
                            <p class="tool-card-description">Monitor server health, performance, and manage game instances.</p>
                        </div>
                    </a>

                    <a href="#" onclick="showPage('moderation'); return false;" class="tool-card">
                        <div class="tool-card-header">
                            <span class="tool-card-icon">üõ°Ô∏è</span>
                            <h4 class="tool-card-title">Chat Moderation</h4>
                        </div>
                        <div class="tool-card-body">
                            <p class="tool-card-description">Manage chat messages, moderate conversations, and handle reports.</p>
                        </div>
                    </a>

                    <a href="#" onclick="showPage('analytics'); return false;" class="tool-card">
                        <div class="tool-card-header">
                            <span class="tool-card-icon">üìä</span>
                            <h4 class="tool-card-title">Game Analytics</h4>
                        </div>
                        <div class="tool-card-body">
                            <p class="tool-card-description">View detailed analytics about player behavior and game performance.</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- Quest Manager Section -->
        <div id="quests-content" class="page-content" style="display: none;">
            <div class="quest-designer-container">
                <!-- Toolbar -->
                <div class="quest-toolbar">
                    <div class="quest-toolbar-left">
                        <h2>üó°Ô∏è Quest Designer</h2>
                        <div class="quest-settlement-select">
                            <label>Settlement:</label>
                            <select id="questSettlementSelect" onchange="window.onQuestSettlementChange && window.onQuestSettlementChange()">
                            </select>
                        </div>
                        <div class="quest-select">
                            <label>Quest:</label>
                            <select id="questSelect" onchange="window.onQuestChange && window.onQuestChange()">
                                <option value="" disabled selected>-- Select or Create --</option>
                            </select>
                        </div>
                        <span id="questOptionCounter">0 options</span>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <button class="quest-zoom-btn" title="Zoom Out" onclick="window.changeQuestZoom(-0.1)">‚àí</button>
                            <span id="questZoomIndicator" class="quest-zoom-indicator">100%</span>
                            <button class="quest-zoom-btn" title="Zoom In" onclick="window.changeQuestZoom(0.1)">+</button>
                        </div>
                    </div>
                    <div class="quest-toolbar-right">
                        <button id="addOptionBtn" class="btn-primary">+ Add Option</button>
                        <button id="saveQuestBtn" class="btn-success" onclick="window.saveQuest()">üíæ Save</button>
                    </div>
                </div>
                
                <!-- Main content area with canvas and sidebar -->
                <div class="quest-main-area">
                    <!-- Canvas Area -->
                    <div class="quest-canvas-wrapper">
                        <!-- Canvas -->
                        <div id="questCanvas" class="quest-canvas">
                            <svg id="questConnectionsSvg" class="quest-connections-svg">
                                <defs>
                                    <marker id="arrowRequires" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                        <polygon points="0 0, 10 3.5, 0 7" fill="rgb(100, 149, 237)"/>
                                    </marker>
                                </defs>
                                <path id="questConnectionPreview" class="quest-connection-preview" style="display:none"></path>
                            </svg>
                            
                            <div id="questOptionsContainer" class="quest-options-container">
                                <!-- Quest Starting Slide (inside container to zoom/pan with nodes) -->
                                <div id="questStartSlide" class="quest-start-slide">
                                    <div class="quest-start-header">
                                        <span class="quest-start-badge">üü¢ START</span>
                                        <button class="quest-start-bg-btn" onclick="window.openQuestAssetModal()" title="Set background">üñºÔ∏è</button>
                                    </div>
                                    <div id="questSlideBody" class="quest-start-body" onclick="window.openQuestAssetModal()">
                                        <div class="quest-start-placeholder">
                                            <span>üì∑</span>
                                            <p>Click to set background</p>
                                        </div>
                                        <input type="text" id="questNameInput" class="quest-name-input" placeholder="Quest Name..." onclick="event.stopPropagation()" oninput="window.updateQuestName && window.updateQuestName(this.value)">
                                        <textarea id="questStartText" class="quest-start-text" placeholder="Enter the starting quest text..." onclick="event.stopPropagation()" oninput="window.updateQuestStartText && window.updateQuestStartText(this.value)"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Navigation Controls -->
                            <div class="quest-nav-controls">
                                <button class="quest-nav-btn" onclick="window.panQuestCanvas(0, 100)" title="Pan Up">‚ñ≤</button>
                                <div class="nav-row">
                                    <button class="quest-nav-btn" onclick="window.panQuestCanvas(100, 0)" title="Pan Left">‚óÄ</button>
                                    <button class="quest-nav-btn nav-center" onclick="window.resetQuestView()" title="Reset View">‚äô</button>
                                    <button class="quest-nav-btn" onclick="window.panQuestCanvas(-100, 0)" title="Pan Right">‚ñ∂</button>
                                </div>
                                <button class="quest-nav-btn" onclick="window.panQuestCanvas(0, -100)" title="Pan Down">‚ñº</button>
                            </div>
                            
                            <!-- Connection Legend -->
                            <div class="connection-legend">
                                <h4>Connections</h4>
                                <div class="legend-item">
                                    <div class="legend-line show"></div>
                                    <span>Shows option</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-line hide"></div>
                                    <span>Hides option</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Sidebar - Option Properties -->
                    <div id="questOptionSidebar" class="quest-option-sidebar">
                        <!-- No selection state -->
                        <div id="sidebarNoSelection" class="sidebar-no-selection">
                            <span>üìã</span>
                            <p>Select an option node to edit its properties</p>
                        </div>
                        
                        <!-- Option content (hidden until selection) -->
                        <div id="sidebarContent" class="sidebar-content" style="display: none;">
                            <div class="sidebar-header">
                                <h3>Option Properties</h3>
                                <span id="sidebarOptionId" class="sidebar-option-id">Option ID: --</span>
                                <span id="sidebarSaveStatus" class="sidebar-save-status"></span>
                            </div>
                            
                            <!-- Basic Info -->
                            <div class="sidebar-section">
                                <h4>üìù Basic Info</h4>
                                <div class="sidebar-field">
                                    <label>Option Text (player clicks):</label>
                                    <input type="text" id="sidebarOptionText" placeholder="What the player clicks...">
                                </div>
                                <div class="sidebar-field">
                                    <label>Node Text (description):</label>
                                    <textarea id="sidebarNodeText" rows="3" placeholder="Description shown to player..."></textarea>
                                </div>
                                <div class="sidebar-checkbox">
                                    <input type="checkbox" id="sidebarIsStart">
                                    <label for="sidebarIsStart">üü¢ Starting Option</label>
                                </div>
                            </div>
                            
                            <!-- Option Type -->
                            <div class="sidebar-section">
                                <h4>üéØ Option Type</h4>
                                <div class="sidebar-field">
                                    <label>Type:</label>
                                    <select id="sidebarOptionType">
                                        <option value="dialogue">üí¨ Dialogue</option>
                                        <option value="stat_check">üìä Stat Check</option>
                                        <option value="effect_check">‚ú® Effect Check</option>
                                        <option value="combat">‚öîÔ∏è Combat</option>
                                        <option value="end">üèÅ Quest End</option>
                                    </select>
                                </div>
                                
                                <!-- Stat Check Fields -->
                                <div id="optionTypeStatCheck" class="option-type-fields" style="display:none;">
                                    <div class="sidebar-row">
                                        <div class="sidebar-field">
                                            <label>Stat:</label>
                                            <select id="sidebarStatType">
                                                <option value="">-- Select --</option>
                                                <option value="strength">Strength</option>
                                                <option value="stamina">Stamina</option>
                                                <option value="agility">Agility</option>
                                                <option value="luck">Luck</option>
                                                <option value="armor">Armor</option>
                                            </select>
                                        </div>
                                        <div class="sidebar-field">
                                            <label>Required:</label>
                                            <input type="number" id="sidebarStatRequired" placeholder="0">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Effect Check Fields -->
                                <div id="optionTypeEffectCheck" class="option-type-fields" style="display:none;">
                                    <div class="sidebar-row">
                                        <div class="sidebar-field">
                                            <label>Effect:</label>
                                            <select id="sidebarEffectId">
                                                <option value="">-- Select --</option>
                                            </select>
                                        </div>
                                        <div class="sidebar-field">
                                            <label>Amount:</label>
                                            <input type="number" id="sidebarEffectAmount" placeholder="0">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Combat Fields -->
                                <div id="optionTypeCombat" class="option-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Select Enemy:</label>
                                        <input type="hidden" id="sidebarEnemyId">
                                        <div id="questEnemyPickerGrid" class="quest-enemy-picker-grid">
                                            <!-- Enemy items populated by JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Rewards -->
                            <div class="sidebar-section">
                                <h4>üéÅ Reward</h4>
                                <div class="sidebar-field">
                                    <label>Reward Type:</label>
                                    <select id="sidebarRewardType">
                                        <option value="">-- None --</option>
                                        <option value="stat">üìä Stat Bonus</option>
                                        <option value="talent">‚≠ê Talent Point</option>
                                        <option value="item">üéí Item</option>
                                        <option value="potion">üß™ Potion</option>
                                        <option value="perk">üí™ Perk</option>
                                        <option value="blessing">üôè Blessing</option>
                                    </select>
                                </div>
                                
                                <!-- Stat Reward Fields -->
                                <div id="rewardTypeStat" class="reward-type-fields" style="display:none;">
                                    <div class="sidebar-row">
                                        <div class="sidebar-field">
                                            <label>Stat:</label>
                                            <select id="sidebarRewardStatType">
                                                <option value="">-- Select --</option>
                                                <option value="strength">Strength</option>
                                                <option value="stamina">Stamina</option>
                                                <option value="agility">Agility</option>
                                                <option value="luck">Luck</option>
                                                <option value="armor">Armor</option>
                                            </select>
                                        </div>
                                        <div class="sidebar-field">
                                            <label>Amount:</label>
                                            <input type="number" id="sidebarRewardStatAmount" placeholder="0">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Item Reward Fields -->
                                <div id="rewardTypeItem" class="reward-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Item:</label>
                                        <select id="sidebarRewardItem">
                                            <option value="">-- Select Item --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Potion Reward Fields -->
                                <div id="rewardTypePotion" class="reward-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Potion:</label>
                                        <select id="sidebarRewardPotion">
                                            <option value="">-- Select Potion --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Perk Reward Fields -->
                                <div id="rewardTypePerk" class="reward-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Perk:</label>
                                        <select id="sidebarRewardPerk">
                                            <option value="">-- Select Perk --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Blessing Reward Fields -->
                                <div id="rewardTypeBlessing" class="reward-type-fields" style="display:none;">
                                    <div class="sidebar-field">
                                        <label>Blessing:</label>
                                        <select id="sidebarRewardBlessing">
                                            <option value="">-- Select Blessing --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Hidden checkbox for talent (used when reward type is talent) -->
                                <input type="hidden" id="sidebarRewardTalent">
                            </div>
                            
                            <!-- Requirements -->
                            <div class="sidebar-section">
                                <h4>üîó Requirements</h4>
                                <div class="sidebar-field">
                                    <label>This option requires:</label>
                                    <div id="sidebarRequires" class="visibility-tags"></div>
                                </div>
                                <div class="sidebar-field">
                                    <label>Required by:</label>
                                    <div id="sidebarRequiredBy" class="visibility-tags"></div>
                                </div>
                                <p class="sidebar-hint">Drag from an option to another to set it as a requirement (target requires source)</p>
                            </div>
                            
                            <!-- Actions -->
                            <div class="sidebar-actions">
                                <button id="sidebarDeleteOption" class="btn-delete" onclick="window.deleteSelectedOption()">üóëÔ∏è Delete Option</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- New Quest Modal -->
            <div id="newQuestModal" class="quest-modal">
                <div class="quest-modal-content">
                    <h3>Create New Quest</h3>
                    <div>
                        <label>Quest Name:</label>
                        <input type="text" id="newQuestName" placeholder="Enter quest name...">
                    </div>
                    <div class="quest-modal-actions">
                        <button class="btn-cancel" onclick="window.closeNewQuestModal()">Cancel</button>
                        <button class="btn-save" onclick="window.createNewQuest()">Create</button>
                    </div>
                </div>
            </div>
            
            <!-- Quest Asset Modal -->
            <div id="questAssetModal" class="quest-modal">
                <div class="quest-modal-content quest-asset-modal-content">
                    <h3>Select Quest Background</h3>
                    <div class="quest-asset-upload-area" id="questAssetUploadArea">
                        <span>üì§</span>
                        <p>Drop an image here or click to upload</p>
                        <input type="file" id="questAssetFileInput" accept="image/*" style="display:none">
                    </div>
                    <div id="questAssetUploadStatus" class="quest-asset-upload-status" style="display:none"></div>
                    <div class="quest-asset-gallery" id="questAssetGallery">
                        <!-- Assets will be populated here -->
                    </div>
                    <div class="quest-modal-actions">
                        <button class="btn-cancel" onclick="window.closeQuestAssetModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enemy Designer Section -->
        <div id="enemies-content" class="page-content" style="display: none;">
            <div class="enemy-designer-container">
                <!-- Left Sidebar - Enemy Lists -->
                <div class="enemy-list-sidebar">
                    <div class="enemy-list-controls">
                        <div class="enemy-tab-toggle">
                            <button type="button" id="gameEnemiesTab" class="tab-btn active">üéÆ Game</button>
                            <button type="button" id="pendingEnemiesTab" class="tab-btn">‚è≥ Pending</button>
                        </div>
                        <input type="text" id="enemySearch" placeholder="Search enemies...">
                        <button type="button" id="newEnemyBtn" class="btn-new">+ New Enemy</button>
                        <button type="button" id="mergeEnemiesBtn" class="btn-merge" style="display: none;">üîÄ Merge Approved</button>
                    </div>
                    <div id="enemyList" class="enemy-list"></div>
                    <div id="pendingEnemyList" class="enemy-list" style="display: none;"></div>
                </div>

                <!-- Main Content - Enemy Form -->
                <div class="enemy-form-container">
                    <form id="enemyForm">
                        <!-- Top Row: Basic Info -->
                        <div class="enemy-form-row">
                            <!-- Icon -->
                            <div class="enemy-icon-section">
                                <div class="enemy-icon-upload-area" id="enemyIconUploadArea">
                                    <div class="enemy-icon-preview" id="enemyIconPreview">
                                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                            <polyline points="17 8 12 3 7 8"/>
                                            <line x1="12" y1="3" x2="12" y2="15"/>
                                        </svg>
                                        <span>Drop image here</span>
                                    </div>
                                </div>
                                <input type="file" id="enemyIconFile" accept="image/*" style="display: none;">
                                <button type="button" id="enemyAssetGalleryBtn" class="btn-gallery">üìÅ Browse Assets</button>
                            </div>

                            <!-- Name & ID -->
                            <div class="enemy-name-section">
                                <div class="form-group">
                                    <label for="enemyId">ID</label>
                                    <input type="text" id="enemyId" readonly value="New">
                                </div>
                                <div class="form-group">
                                    <label for="enemyName">Name</label>
                                    <input type="text" id="enemyName" required placeholder="Enemy name...">
                                </div>
                            </div>

                            <!-- Stats -->
                            <div class="enemy-stats-section">
                                <div class="enemy-stats-section-title">Stats</div>
                                <div class="enemy-stats-grid">
                                    <div class="stat-group">
                                        <label>Strength</label>
                                        <input type="number" id="enemyStrength" min="0" max="999" value="0">
                                    </div>
                                    <div class="stat-group">
                                        <label>Stamina</label>
                                        <input type="number" id="enemyStamina" min="0" max="999" value="0">
                                    </div>
                                    <div class="stat-group">
                                        <label>Agility</label>
                                        <input type="number" id="enemyAgility" min="0" max="999" value="0">
                                    </div>
                                    <div class="stat-group">
                                        <label>Luck</label>
                                        <input type="number" id="enemyLuck" min="0" max="999" value="0">
                                    </div>
                                    <div class="stat-group">
                                        <label>Armor</label>
                                        <input type="number" id="enemyArmor" min="0" max="999" value="0">
                                    </div>
                                    <div class="stat-group">
                                        <label>Damage</label>
                                        <div class="damage-range">
                                            <input type="number" id="enemyMinDamage" min="0" max="999" value="0" placeholder="Min">
                                            <span>-</span>
                                            <input type="number" id="enemyMaxDamage" min="0" max="999" value="0" placeholder="Max">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="enemy-form-row">
                            <div class="enemy-description-section">
                                <label for="enemyDescription">Description</label>
                                <textarea id="enemyDescription" rows="2" placeholder="Enemy description..."></textarea>
                            </div>
                        </div>

                        <!-- Talent Tree -->
                        <div class="enemy-form-row">
                            <div class="enemy-talent-section">
                                <h3>Talent Tree <span class="talent-hint">(Click to upgrade)</span></h3>
                                <div id="talentTreeGrid" class="talent-tree-grid">
                                    <!-- 7x8 grid will be populated by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="enemy-form-actions">
                            <button type="submit" id="enemySaveBtn" class="btn-save">üíæ Save to Pending</button>
                            <button type="button" id="enemyCancelBtn" class="btn-cancel">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Enemy Asset Gallery Overlay -->
            <div id="enemyAssetGalleryOverlay" class="asset-gallery-overlay" style="display: none;">
                <div class="asset-gallery">
                    <div class="asset-gallery-header">
                        <h3>Enemy Assets</h3>
                        <button type="button" id="enemyAssetGalleryClose" class="btn-close">‚úï</button>
                    </div>
                    <div class="asset-gallery-actions">
                        <button type="button" id="enemyUploadNewBtn" class="btn-upload">üì§ Upload New</button>
                    </div>
                    <div id="enemyAssetGrid" class="asset-gallery-grid"></div>
                </div>
            </div>
        </div>

        <!-- Item Designer Section -->
        <div id="items-content" class="page-content" style="display: none;">
            <div class="items-designer-container">
                <!-- Left Sidebar - Item Lists -->
                <div class="item-list-sidebar">
                    <div class="item-list-controls">
                        <div class="item-tab-toggle">
                            <button type="button" id="gameItemsTab" class="tab-btn active">üéÆ Game Items</button>
                            <button type="button" id="pendingItemsTab" class="tab-btn">‚è≥ Pending</button>
                        </div>
                        <input type="text" id="itemSearch" placeholder="Search items...">
                        <select id="itemTypeFilter">
                            <option value="">All Types</option>
                            <option value="head">Head</option>
                            <option value="chest">Chest</option>
                            <option value="hands">Hands</option>
                            <option value="feet">Feet</option>
                            <option value="belt">Belt</option>
                            <option value="legs">Legs</option>
                            <option value="back">Back</option>
                            <option value="amulet">Amulet</option>
                            <option value="weapon">Weapon</option>
                            <option value="hammer">Hammer</option>
                            <option value="gem">Gem</option>
                            <option value="scroll">Scroll</option>
                            <option value="potion">Potion</option>
                        </select>
                    </div>
                    
                    <!-- Item List (shows either game or pending based on tab) -->
                    <div id="itemListContainer" class="item-list-container">
                        <div id="itemList"></div>
                        <div id="pendingItemList" style="display: none;"></div>
                    </div>
                    
                    <div class="item-list-buttons">
                        <button type="button" id="newItemBtn">+ New Item</button>
                        <button type="button" id="mergeItemsBtn" class="btn-merge" style="display: none;">üîÑ Merge Approved</button>
                    </div>
                </div>

                <!-- Right Panel - Item Editor -->
                <div class="item-editor-panel">
                    <h2 id="itemEditorTitle">Create New Item</h2>
                    
                    <form id="itemForm">
                        <!-- Basic Info Section -->
                        <div class="form-section">
                            <div class="form-section-title">Basic Information</div>
                            <div class="item-basic-info">
                                <div>
                                    <label for="itemName">Item Name</label>
                                    <input type="text" id="itemName" placeholder="Enter item name" required>
                                </div>
                                <div>
                                    <label for="itemType">Type</label>
                                    <select id="itemType" required>
                                        <option value="">Select Type</option>
                                        <option value="head">Head</option>
                                        <option value="chest">Chest</option>
                                        <option value="hands">Hands</option>
                                        <option value="feet">Feet</option>
                                        <option value="belt">Belt</option>
                                        <option value="legs">Legs</option>
                                        <option value="back">Back</option>
                                        <option value="amulet">Amulet</option>
                                        <option value="weapon">Weapon</option>
                                        <option value="hammer">Hammer</option>
                                        <option value="gem">Gem</option>
                                        <option value="scroll">Scroll</option>
                                        <option value="potion">Potion</option>
                                        <option value="elixir">Elixir</option>
                                        <option value="ingredient">Ingredient</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="itemSilver">Silver Cost</label>
                                    <input type="number" id="itemSilver" value="10" min="0">
                                </div>
                                <input type="hidden" id="itemId">
                                <input type="hidden" id="itemAssetID" value="1">
                            </div>
                        </div>

                        <!-- Icon Section -->
                        <div class="form-section">
                            <div class="form-section-title">Icon</div>
                            <div class="item-icon-section">
                                <div class="item-icon-preview" id="itemIconUploadArea">
                                    <img id="itemIconPreview" src="" alt="No icon selected">
                                    <span id="itemIconPlaceholder">Click to upload or drag & drop</span>
                                </div>
                                <input type="file" id="itemIconFile" accept="image/*" style="display: none;">
                                <div class="item-icon-info">
                                    <span id="itemAssetIDDisplay">Asset ID: None</span>
                                    <div class="item-icon-buttons">
                                        <button type="button" id="itemAssetGalleryBtn" class="btn-browse-assets">üé® Browse Assets</button>
                                        <button type="button" id="itemUploadNewBtn" class="btn-upload-new">üì§ Upload New</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Section with Socket -->
                        <div class="form-section">
                            <div class="form-section-title">Stats & Socket</div>
                            <div class="item-stats-grid">
                                <div class="stat-input-group">
                                    <label for="itemStrength">Strength</label>
                                    <input type="number" id="itemStrength" min="0" placeholder="0">
                                </div>
                                <div class="stat-input-group">
                                    <label for="itemStamina">Stamina</label>
                                    <input type="number" id="itemStamina" min="0" placeholder="0">
                                </div>
                                <div class="stat-input-group">
                                    <label for="itemAgility">Agility</label>
                                    <input type="number" id="itemAgility" min="0" placeholder="0">
                                </div>
                                <div class="stat-input-group">
                                    <label for="itemLuck">Luck</label>
                                    <input type="number" id="itemLuck" min="0" placeholder="0">
                                </div>
                                <div class="stat-input-group">
                                    <label for="itemArmor">Armor</label>
                                    <input type="number" id="itemArmor" min="0" placeholder="0">
                                </div>
                                <div class="socket-checkbox-group">
                                    <input type="checkbox" id="itemSocket">
                                    <label for="itemSocket">Has Socket</label>
                                </div>
                            </div>
                        </div>

                        <!-- Weapon Stats Section (conditional) -->
                        <div id="weaponStatsSection" class="form-section">
                            <div class="form-section-title">Weapon Stats</div>
                            <div class="weapon-stats-grid">
                                <div class="stat-input-group">
                                    <label for="itemMinDamage">Min Damage</label>
                                    <input type="number" id="itemMinDamage" min="0" placeholder="0">
                                </div>
                                <div class="stat-input-group">
                                    <label for="itemMaxDamage">Max Damage</label>
                                    <input type="number" id="itemMaxDamage" min="0" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- Effect Section -->
                        <div class="form-section">
                            <div class="form-section-title">Effect</div>
                            <div class="effect-row">
                                <div>
                                    <label for="itemEffect">Effect</label>
                                    <select id="itemEffect">
                                        <option value="">-- No Effect --</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="itemEffectFactor">Factor</label>
                                    <input type="number" id="itemEffectFactor" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div class="form-section">
                            <div class="form-section-title">Notes</div>
                            <div class="item-notes-section">
                                <textarea id="itemNotes" placeholder="Enter notes about this item..."></textarea>
                            </div>
                        </div>

                        <!-- Form Buttons -->
                        <div class="item-form-buttons">
                            <button type="button" id="itemCancelBtn" class="btn-cancel-item">Cancel</button>
                            <button type="submit" class="btn-save-item">Save Item</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Item Asset Gallery Overlay -->
            <div id="itemAssetGalleryOverlay" class="item-asset-gallery-overlay hidden">
                <div class="item-asset-gallery">
                    <div class="item-asset-gallery-header">
                        <h3>üé® Select Item Asset</h3>
                        <button type="button" id="itemAssetGalleryClose" class="asset-gallery-close">‚úï</button>
                    </div>
                    <div id="itemAssetGrid" class="item-asset-grid custom-scrollbar">
                        <!-- Asset items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Perk Designer Section -->
        <div id="perks-content" class="page-content" style="display: none;">
            <div class="perks-designer-container">
                <!-- Left Sidebar - Perk Lists -->
                <div class="perk-list-sidebar">
                    <div class="perk-list-controls">
                        <div class="perk-tab-toggle">
                            <button type="button" id="gamePerksTab" class="tab-btn active">üéÆ Game Perks</button>
                            <button type="button" id="pendingPerksTab" class="tab-btn">‚è≥ Pending</button>
                        </div>
                        <input type="text" id="perkSearch" placeholder="Search perks...">
                    </div>
                    
                    <!-- Perk List (shows either game or pending based on tab) -->
                    <div id="perkListContainer" class="perk-list-container">
                        <div id="perkList"></div>
                        <div id="pendingPerkList" style="display: none;"></div>
                    </div>
                    
                    <div class="perk-list-buttons">
                        <button type="button" id="newPerkBtn">+ New Perk</button>
                        <button type="button" id="mergePerksBtn" class="btn-merge" style="display: none;">üîÑ Merge Approved</button>
                    </div>
                </div>

                <!-- Right Panel - Perk Editor -->
                <div class="perk-editor-panel">
                    <h2 id="perkEditorTitle">Create New Perk</h2>
                    
                    <form id="perkForm">
                        <!-- Basic Info Section -->
                        <div class="perk-form-section">
                            <div class="perk-form-section-title">Basic Information</div>
                            <div class="perk-basic-info">
                                <div>
                                    <label for="perkName">Perk Name</label>
                                    <input type="text" id="perkName" placeholder="Enter perk name" required>
                                </div>
                                <input type="hidden" id="perkId">
                                <input type="hidden" id="perkAssetID" value="1">
                            </div>
                        </div>

                        <!-- Icon Section -->
                        <div class="perk-form-section">
                            <div class="perk-form-section-title">Icon</div>
                            <div class="perk-icon-section">
                                <div class="perk-icon-preview" id="perkIconUploadArea">
                                    <img id="perkIconPreview" src="" alt="No icon selected">
                                    <span id="perkIconPlaceholder">Click to upload or drag & drop</span>
                                </div>
                                <input type="file" id="perkIconFile" accept="image/*" style="display: none;">
                                <div class="perk-icon-info">
                                    <span id="perkAssetIDDisplay">Asset ID: None</span>
                                    <div class="perk-icon-buttons">
                                        <button type="button" id="perkAssetGalleryBtn" class="btn-browse-perk-assets">üé® Browse Assets</button>
                                        <button type="button" id="perkUploadNewBtn" class="btn-upload-perk-new">üì§ Upload New</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Effects Section -->
                        <div class="perk-form-section">
                            <div class="perk-form-section-title">Effects</div>
                            <div class="perk-effects-list">
                                <div class="perk-effect-item">
                                    <div class="perk-effect-inputs">
                                        <div class="perk-effect-select-wrapper">
                                            <label for="perkEffect1">Effect 1</label>
                                            <select id="perkEffect1">
                                                <option value="">-- No Effect --</option>
                                            </select>
                                        </div>
                                        <div class="perk-factor-wrapper">
                                            <label for="perkFactor1">Factor</label>
                                            <input type="number" id="perkFactor1" placeholder="0">
                                        </div>
                                    </div>
                                    <span class="perk-effect-description" id="perkEffect1Desc">Select an effect to see description</span>
                                </div>
                                <div class="perk-effect-item">
                                    <div class="perk-effect-inputs">
                                        <div class="perk-effect-select-wrapper">
                                            <label for="perkEffect2">Effect 2</label>
                                            <select id="perkEffect2">
                                                <option value="">-- No Effect --</option>
                                            </select>
                                        </div>
                                        <div class="perk-factor-wrapper">
                                            <label for="perkFactor2">Factor</label>
                                            <input type="number" id="perkFactor2" placeholder="0">
                                        </div>
                                    </div>
                                    <span class="perk-effect-description" id="perkEffect2Desc">Select an effect to see description</span>
                                </div>
                            </div>
                        </div>

                        <!-- Description Section -->
                        <div class="perk-form-section">
                            <div class="perk-form-section-title">Description</div>
                            <div class="perk-basic-info">
                                <div style="grid-column: span 2;">
                                    <textarea id="perkDescription" rows="4" placeholder="Enter perk description..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Blessing Section -->
                        <div class="perk-form-section">
                            <div class="perk-basic-info">
                                <div style="grid-column: span 2;">
                                    <label class="perk-blessing-checkbox">
                                        <input type="checkbox" id="perkIsBlessing">
                                        <span>‚≠ê Is Blessing (Special Perk)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Form Buttons -->
                        <div class="perk-form-buttons">
                            <button type="button" id="perkCancelBtn" class="btn-cancel-perk">Cancel</button>
                            <button type="submit" class="btn-save-perk">Save Perk</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Perk Asset Gallery Overlay -->
            <div id="perkAssetGalleryOverlay" class="perk-asset-gallery-overlay hidden">
                <div class="perk-asset-gallery">
                    <div class="perk-asset-gallery-header">
                        <h3>üé® Select Perk Asset</h3>
                        <button type="button" id="perkAssetGalleryClose" class="perk-asset-gallery-close">‚úï</button>
                    </div>
                    <div id="perkAssetGrid" class="perk-asset-grid custom-scrollbar">
                        <!-- Asset items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Expedition Designer Section -->
        <div id="dungeons-content" class="page-content" style="display: none;">
            <div class="expedition-designer-container">
                <!-- Toolbar -->
                <div class="expedition-toolbar">
                    <div class="toolbar-left">
                        <h2>üó∫Ô∏è Expedition Designer</h2>
                        <div class="expedition-settlement-select">
                            <label>Settlement:</label>
                            <select id="expeditionSettlementSelect" onchange="window.onExpeditionSettlementChange && window.onExpeditionSettlementChange()">
                            </select>
                        </div>
                        <span id="slideCounter">0 slides</span>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <button id="zoomOutBtn" class="zoom-btn" title="Zoom Out" onclick="window.changeZoom(-0.1)">‚àí</button>
                            <span id="zoomIndicator" class="zoom-indicator">100%</span>
                            <button id="zoomInBtn" class="zoom-btn" title="Zoom In" onclick="window.changeZoom(0.1)">+</button>
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <button id="addSlideBtn" class="btn-primary">+ Add Slide</button>
                        <button id="saveExpeditionBtn" class="btn-success" onclick="window.saveExpedition()">üíæ Save</button>
                    </div>
                </div>
                
                <!-- Canvas -->
                <div id="expeditionCanvas" class="expedition-canvas">
                    <svg id="connectionsSvg" class="connections-svg">
                        <path id="connectionPreview" class="connection-preview" style="display:none"></path>
                    </svg>
                    <div id="slidesContainer" class="slides-container"></div>
                    
                    <!-- Navigation Controls -->
                    <div class="canvas-nav-controls">
                        <button class="nav-btn" onclick="window.panCanvas(0, 100)" title="Pan Up">‚ñ≤</button>
                        <div class="nav-row">
                            <button class="nav-btn" onclick="window.panCanvas(100, 0)" title="Pan Left">‚óÄ</button>
                            <button class="nav-btn nav-center" onclick="window.centerCanvas()" title="Center">‚äô</button>
                            <button class="nav-btn" onclick="window.panCanvas(-100, 0)" title="Pan Right">‚ñ∂</button>
                        </div>
                        <button class="nav-btn" onclick="window.panCanvas(0, -100)" title="Pan Down">‚ñº</button>
                    </div>
                </div>
            </div>
            
            <!-- Option Modal -->
            <div id="optionModal" class="option-modal">
                <div class="option-modal-content">
                    <h3 id="optionModalTitle">Add Option</h3>
                    <div class="modal-field">
                        <label>Option Text</label>
                        <input type="text" id="optionModalText" placeholder="Enter option text...">
                    </div>
                    <div class="modal-field">
                        <label>Type</label>
                        <select id="optionModalType" onchange="window.updateOptionModalFields && window.updateOptionModalFields(this.value)">
                            <option value="dialogue">üí¨ Dialogue (no check)</option>
                            <option value="skill">üéØ Skill Check (stat requirement)</option>
                            <option value="effect">‚ú® Effect Check (effect requirement)</option>
                            <option value="combat">‚öîÔ∏è Combat (enemy encounter)</option>
                        </select>
                    </div>
                    
                    <!-- Skill Check Fields -->
                    <div id="optionStatFields" class="modal-field-row" style="display:none;">
                        <div class="modal-field">
                            <label>Stat Type</label>
                            <select id="optionStatType">
                                <option value="">Select stat...</option>
                                <option value="strength">Strength</option>
                                <option value="agility">Agility</option>
                                <option value="stamina">Stamina</option>
                                <option value="luck">Luck</option>
                                <option value="armor">Armor</option>
                            </select>
                        </div>
                        <div class="modal-field">
                            <label>Required Amount</label>
                            <input type="number" id="optionStatRequired" placeholder="e.g. 50" min="1">
                        </div>
                    </div>
                    
                    <!-- Effect Check Fields -->
                    <div id="optionEffectFields" class="modal-field-row" style="display:none;">
                        <div class="modal-field">
                            <label>Effect</label>
                            <select id="optionEffectId">
                                <option value="">Select effect...</option>
                                <!-- Populated dynamically from global effects array -->
                            </select>
                        </div>
                        <div class="modal-field">
                            <label>Required Amount</label>
                            <input type="number" id="optionEffectAmount" placeholder="e.g. 10" min="1">
                        </div>
                    </div>
                    
                    <!-- Combat Fields -->
                    <div id="optionCombatFields" class="modal-field" style="display:none;">
                        <label>Select Enemy</label>
                        <input type="hidden" id="optionEnemyId" value="">
                        <div id="enemyPickerGrid" class="enemy-picker-grid">
                            <!-- Populated dynamically with enemy icons -->
                        </div>
                    </div>
                    
                    <div class="modal-buttons">
                        <button id="optionModalCancel" class="btn-cancel" onclick="window.closeOptionModal()">Cancel</button>
                        <button id="optionModalSave" class="btn-primary" onclick="window.saveOptionFromModal()">Save</button>
                    </div>
                </div>
            </div>
            
            <!-- Background Picker Modal -->
            <div id="bgPickerModal" class="option-modal">
                <div class="option-modal-content" style="width:520px;">
                    <h3>Select Background Image</h3>
                    <div id="bgAssetsGrid" class="bg-assets-grid">
                        <p style="color:#888;text-align:center;">Loading...</p>
                    </div>
                    <div class="modal-field" style="margin-top:16px;">
                        <label>Or upload from device / enter URL:</label>
                        <div style="display:flex;gap:8px;margin-top:8px;">
                            <button class="btn-secondary" onclick="window.uploadSlideBgFromDevice()">üìÅ From Device</button>
                            <input type="text" id="bgUrlInput" placeholder="https://..." style="flex:1;">
                            <button class="btn-primary" onclick="applyBgUrl()">Apply URL</button>
                        </div>
                        <span id="bgUploadStatus" style="color:#888;font-size:0.8rem;margin-top:4px;display:block;"></span>
                    </div>
                    <div class="modal-buttons">
                        <button class="btn-cancel" onclick="clearSlideBg()">Clear Background</button>
                        <button class="btn-cancel" onclick="closeBgPicker()">Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- Reward Modal -->
            <div id="rewardModal" class="option-modal">
                <div class="option-modal-content">
                    <h3>Slide Reward</h3>
                    <div class="modal-field">
                        <label>Reward Type</label>
                        <select id="rewardModalType" onchange="window.updateRewardModalFields && window.updateRewardModalFields(this.value)">
                            <option value="stat">üìä Stat Bonus</option>
                            <option value="talent">‚≠ê Talent Point</option>
                            <option value="item">üéí Item</option>
                            <option value="perk">üîÆ Perk</option>
                            <option value="blessing">‚ú® Blessing</option>
                            <option value="potion">üß™ Potion</option>
                        </select>
                    </div>
                    
                    <!-- Stat Bonus Fields -->
                    <div id="rewardStatFields" class="modal-field">
                        <label>Stat Type</label>
                        <select id="rewardStatType">
                            <option value="strength">üí™ Strength</option>
                            <option value="stamina">‚ù§Ô∏è Stamina</option>
                            <option value="agility">üèÉ Agility</option>
                            <option value="luck">üçÄ Luck</option>
                            <option value="armor">üõ°Ô∏è Armor</option>
                        </select>
                        <label style="margin-top:8px;">Amount</label>
                        <input type="number" id="rewardStatAmount" value="1" min="1" max="100">
                    </div>
                    
                    <!-- Item Fields -->
                    <div id="rewardItemFields" class="modal-field" style="display:none;">
                        <label>Select Item</label>
                        <input type="hidden" id="rewardItemId" value="">
                        <div id="rewardItemPickerGrid" class="item-picker-grid">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                    
                    <!-- Perk Fields -->
                    <div id="rewardPerkFields" class="modal-field" style="display:none;">
                        <label>Select Perk</label>
                        <select id="rewardPerkId">
                            <option value="">-- Select a perk --</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    
                    <!-- Blessing Fields -->
                    <div id="rewardBlessingFields" class="modal-field" style="display:none;">
                        <label>Select Blessing</label>
                        <select id="rewardBlessingId">
                            <option value="">-- Select a blessing --</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    
                    <!-- Potion Fields -->
                    <div id="rewardPotionFields" class="modal-field" style="display:none;">
                        <label>Select Potion</label>
                        <input type="hidden" id="rewardPotionId" value="">
                        <div id="rewardPotionPickerGrid" class="item-picker-grid">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                    
                    <div class="modal-buttons">
                        <button class="btn-cancel" onclick="window.closeRewardModal()">Cancel</button>
                        <button class="btn-primary" onclick="window.saveRewardFromModal()">Save Reward</button>
                    </div>
                </div>
            </div>
            
            <!-- Effect Modal (for slide effects) -->
            <div id="effectModal" class="option-modal">
                <div class="option-modal-content" style="max-width: 400px;">
                    <h3>Slide Effect</h3>
                    <p style="color: #888; font-size: 12px; margin-bottom: 15px;">
                        Effects are applied when a character enters this slide (e.g., health loss, stat debuffs).
                    </p>
                    <div class="modal-field">
                        <label>Effect Type</label>
                        <select id="slideEffectId">
                            <option value="">-- Select an effect --</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Factor (amount)</label>
                        <input type="number" id="slideEffectFactor" value="0" placeholder="e.g., -10 for health loss">
                        <small style="color: #888;">Negative values for penalties (e.g., -10 health), positive for buffs</small>
                    </div>
                    <div class="modal-buttons">
                        <button class="btn-cancel" onclick="window.closeEffectModal()">Cancel</button>
                        <button class="btn-primary" onclick="window.saveEffectFromModal()">Save Effect</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NPC Manager Section -->
        <div id="npcs-content" class="page-content" style="display: none;">
            <div class="tool-header">
                <div class="tool-icon">üë•</div>
                <h1>NPC Manager</h1>
                <p>Create NPCs, manage dialogues, and set up interactive characters.</p>
            </div>
        </div>

        <!-- Settlement Designer Section -->
        <div id="settlements-content" class="page-content" style="display: none;">
            <div id="settlementDesigner" class="settlement-designer">
                <!-- Top bar with settlement selection -->
                <div class="settlement-top-bar">
                    <div class="settlement-select-wrapper">
                        <div class="settlement-select-group">
                            <label for="settlementSelect">Settlement:</label>
                            <select id="settlementSelect" class="settlement-select">
                                <option value="">-- New Settlement --</option>
                            </select>
                        </div>
                        <div class="settlement-description-field">
                            <label for="settlementDescription">Description:</label>
                            <textarea id="settlementDescription" placeholder="Settlement description..."></textarea>
                        </div>
                    </div>
                    <div class="settlement-top-actions">
                        <button id="saveSettlementBtn" class="btn-save-settlement">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Save
                        </button>
                        <button id="deleteSettlementBtn" class="btn-delete-settlement" style="display: none;">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>

                <!-- Cards container - Single row with all 5 cards -->
                <div class="settlement-cards-grid">
                    <!-- Settlement Card -->
                    <div class="settlement-card-wrapper">
                        <h3 class="settlement-card-title">Settlement</h3>
                        <div class="settlement-card">
                            <div id="settlementAssetArea" class="settlement-card-asset" data-asset-id="">
                                <div class="no-asset">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <span>Click to select asset</span>
                                </div>
                            </div>
                            <div class="settlement-card-info">
                                <div>
                                    <label for="settlementName">Name</label>
                                    <input type="text" id="settlementName" placeholder="Settlement name...">
                                </div>
                                <div>
                                    <label for="factionSelect">Faction</label>
                                    <select id="factionSelect" class="faction-select">
                                        <option value="">-- None --</option>
                                        <option value="1">Faction 1</option>
                                        <option value="2">Faction 2</option>
                                        <option value="3">Faction 3</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vendor Card -->
                    <div class="settlement-card-wrapper">
                        <h3 class="settlement-card-title">Vendor <button class="responses-btn" onclick="openResponsesModal('vendor')">üí¨</button></h3>
                        <div class="settlement-card">
                            <div id="vendorAssetArea" class="settlement-card-asset" data-asset-id="">
                                <div class="no-asset">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <span>Click to select asset</span>
                                </div>
                            </div>
                            <div class="settlement-card-info">
                                <div class="vendor-items-section">
                                    <div class="section-header">
                                        <label>Items for Sale</label>
                                        <button id="addVendorItemBtn" class="add-inline-btn">+</button>
                                    </div>
                                    <div id="vendorItemsGrid" class="items-grid">
                                        <!-- Items will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Utility Card -->
                    <div class="settlement-card-wrapper">
                        <div class="utility-type-cards">
                            <div class="utility-type-card" data-type="blacksmith" onclick="selectUtilityType('blacksmith')">
                                Blacksmith
                            </div>
                            <div class="utility-type-card" data-type="alchemist" onclick="selectUtilityType('alchemist')">
                                Alchemist
                            </div>
                            <div class="utility-type-card" data-type="enchanter" onclick="selectUtilityType('enchanter')">
                                Enchanter
                            </div>
                            <div class="utility-type-card" data-type="trainer" onclick="selectUtilityType('trainer')">
                                Trainer
                            </div>
                            <div class="utility-type-card" data-type="church" onclick="selectUtilityType('church')">
                                Church
                            </div>
                            <button class="responses-btn" onclick="openResponsesModal('utility')">üí¨</button>
                        </div>
                        <div class="settlement-card">
                            <div id="utilityAssetArea" class="settlement-card-asset" data-asset-id="">
                                <div class="no-asset">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <span>Click to select asset</span>
                                </div>
                            </div>
                            <div class="settlement-card-info">
                                <!-- Hidden select for form data -->
                                <select id="utilityTypeSelect" style="display: none;">
                                    <option value="">-- Select Utility --</option>
                                    <option value="blacksmith">Blacksmith</option>
                                    <option value="alchemist">Alchemist</option>
                                    <option value="enchanter">Enchanter</option>
                                    <option value="trainer">Trainer</option>
                                    <option value="church">Church</option>
                                </select>
                                
                                <!-- Church: Blessings -->
                                <div id="utilityChurchContent" class="utility-content">
                                    <label>Blessings (Perks)</label>
                                    <div class="blessing-selects">
                                        <select id="blessing1Select">
                                            <option value="">-- None --</option>
                                        </select>
                                        <select id="blessing2Select">
                                            <option value="">-- None --</option>
                                        </select>
                                        <select id="blessing3Select">
                                            <option value="">-- None --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Enchanter: Effects -->
                                <div id="utilityEnchanterContent" class="utility-content">
                                    <div class="section-header">
                                        <label>Available Effects</label>
                                        <button id="addEnchanterEffectBtn" class="add-inline-btn">+</button>
                                    </div>
                                    <div id="enchanterEffectsList" class="effects-list">
                                        <!-- Effects will be populated here -->
                                    </div>
                                </div>
                                
                                <!-- Blacksmith/Alchemist/Trainer: No extra content -->
                                <div id="utilityEmptyContent" class="utility-content">
                                    <p class="utility-empty-msg">No additional configuration needed</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Expedition Card -->
                    <div class="settlement-card-wrapper">
                        <h3 class="settlement-card-title">Expedition</h3>
                        <div class="settlement-card">
                            <div id="expeditionAssetArea" class="settlement-card-asset" data-asset-id="">
                                <div class="no-asset">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <span>Click to select asset</span>
                                </div>
                            </div>
                            <div class="expedition-description-overlay">
                                <textarea id="expeditionDescription" placeholder="Enter expedition description..." class="expedition-textarea"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Arena Card -->
                    <div class="settlement-card-wrapper">
                        <h3 class="settlement-card-title">Arena</h3>
                        <div class="settlement-card">
                            <div id="arenaAssetArea" class="settlement-card-asset" data-asset-id="">
                                <div class="no-asset">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <span>Click to select asset</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Responses Modal -->
                <div id="responsesModalOverlay" class="responses-modal-overlay">
                    <div class="responses-modal">
                        <div class="responses-modal-header">
                            <h3 id="responsesModalTitle">Vendor Responses</h3>
                            <button class="responses-modal-close" onclick="closeResponsesModal()">‚úï</button>
                        </div>
                        <div id="responsesModalContent" class="responses-modal-content">
                            <!-- Dynamic response entries -->
                        </div>
                        <div class="responses-modal-footer">
                            <button class="btn-add-response" onclick="addResponseEntry()">+ Add Response</button>
                            <button class="btn-save-responses" onclick="saveResponses()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- Asset Gallery Overlay -->
                <div id="settlementAssetGalleryOverlay" class="settlement-asset-gallery-overlay">
                    <div class="settlement-asset-gallery">
                        <div class="settlement-asset-gallery-header">
                            <h3 id="settlementGalleryTitle">Select Asset</h3>
                            <button id="settlementGalleryClose" class="settlement-asset-gallery-close">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="settlement-asset-gallery-content">
                            <div id="settlementAssetGrid" class="settlement-asset-grid">
                                <!-- Assets will be populated here -->
                            </div>
                        </div>
                        <div class="settlement-upload-section">
                            <button id="settlementUploadBtn" class="btn-upload-asset">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                Upload New Asset
                            </button>
                            <input type="file" id="settlementAssetFile" accept="image/*" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Management Section -->
        <div id="players-content" class="page-content" style="display: none;">
            <div class="tool-header">
                <div class="tool-icon">üë§</div>
                <h1>Player Management</h1>
                <p>Monitor player activity, handle reports, and manage user accounts.</p>
            </div>
        </div>

        <!-- Server Management Section -->
        <div id="servers-content" class="page-content" style="display: none;">
            <div class="tool-header">
                <div class="tool-icon">üñ•Ô∏è</div>
                <h1>Server Management</h1>
                <p>Monitor server health, performance, and manage game instances.</p>
            </div>
        </div>

        <!-- Chat Moderation Section -->
        <div id="moderation-content" class="page-content" style="display: none;">
            <div class="tool-header">
                <div class="tool-icon">üõ°Ô∏è</div>
                <h1>Chat Moderation</h1>
                <p>Manage chat messages, moderate conversations, and handle reports.</p>
            </div>
        </div>

        <!-- Game Analytics Section -->
        <div id="analytics-content" class="page-content" style="display: none;">
            <div class="tool-header">
                <div class="tool-icon">üìä</div>
                <h1>Game Analytics</h1>
                <p>View detailed analytics about player behavior and game performance.</p>
            </div>
        </div>

        <!-- Asset Gallery Overlay -->
        <div id="assetGalleryOverlay" class="asset-gallery-overlay hidden">
            <div class="asset-gallery">
                <div class="asset-gallery-header">
                    <h3>üé® Choose Existing Asset</h3>
                    <button type="button" class="close-gallery-btn" onclick="toggleAssetGallery()">‚úï</button>
                </div>
                <div class="asset-gallery-grid" id="assetGrid"></div>
            </div>
        </div>
    </div>    <!-- AWS Cognito SDK -->
    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>

    <script>
        // Function to get current access token from Cognito (same as in login.html)
        function getCurrentAccessToken() {
            try {
                const COGNITO_USER_POOL_ID = 'eu-north-1_il4Ww30RF';
                const COGNITO_CLIENT_ID = 'g7sjca510dnqgs2tldhgvbihj';
                const COGNITO_REGION = 'eu-north-1';

                const poolData = {
                    UserPoolId: COGNITO_USER_POOL_ID,
                    ClientId: COGNITO_CLIENT_ID,
                    region: COGNITO_REGION
                };

                const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
                const cognitoUser = userPool.getCurrentUser();

                if (cognitoUser != null) {
                    return new Promise((resolve, reject) => {
                        cognitoUser.getSession((err, session) => {
                            if (err) {
                                reject(err);
                                return;
                            }
                            if (session.isValid()) {
                                resolve(session.getAccessToken().getJwtToken());
                            } else {
                                resolve(null);
                            }
                        });
                    });
                }
                return Promise.resolve(null);
            } catch (error) {
                console.error('Error getting access token:', error);
                return Promise.resolve(null);
            }
        }

        // Simple logout function
        function logout() {
            console.log('Logout called');
            
            // Clear all Cognito-related tokens
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('CognitoIdentityServiceProvider')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                console.log('Removing Cognito key:', key);
                localStorage.removeItem(key);
            });
            
            console.log('Logout successful - redirecting to login');
            window.location.href = 'http://localhost:8080/login';
        }
        
        // Page navigation system
        const pages = {
            'dashboard': { title: 'Dashboard', element: 'dashboard-content' },
            'quests': { title: 'Quest Manager', element: 'quests-content' },
            'enemies': { title: 'Enemy Designer', element: 'enemies-content' },
            'items': { title: 'Item Designer', element: 'items-content' },
            'perks': { title: 'Perk Designer', element: 'perks-content' },
            'dungeons': { title: 'Expeditions', element: 'dungeons-content' },
            'settlements': { title: 'Settlement Designer', element: 'settlements-content' },
            'npcs': { title: 'NPC Manager', element: 'npcs-content' },
            'players': { title: 'Player Management', element: 'players-content' },
            'servers': { title: 'Server Management', element: 'servers-content' },
            'moderation': { title: 'Chat Moderation', element: 'moderation-content' },
            'analytics': { title: 'Game Analytics', element: 'analytics-content' }
        };

        let currentPage = 'dashboard';

        function showPage(pageName) {
            const page = pages[pageName];
            if (!page) {
                console.error('Page not found:', pageName);
                return false;
            }

            console.log('Switching to page:', pageName);
            currentPage = pageName;

            // Hide all page content
            document.querySelectorAll('.page-content').forEach(content => {
                content.style.display = 'none';
            });

            // Show selected page content
            const targetElement = document.getElementById(page.element);
            if (targetElement) {
                targetElement.style.display = 'block';
                
                // If showing the enemy designer, load data
                if (pageName === 'enemies' && window.enemyDesigner) {
                    console.log('Loading enemies and effects data...');
                    window.enemyDesigner.loadEnemiesAndEffects();
                }
                
                // If showing the item designer, load data
                if (pageName === 'items' && window.itemDesigner) {
                    console.log('Loading items and effects data...');
                    window.itemDesigner.loadItemsAndEffects();
                }
                
                // If showing the perk designer, load data
                if (pageName === 'perks' && window.perkDesigner) {
                    console.log('Loading perks and effects data...');
                    window.perkDesigner.loadPerksAndEffects();
                }
                
                // If showing the expedition designer, auto-load data
                if (pageName === 'dungeons') {
                    // Initialize expedition designer if not done yet
                    if (window.initExpeditionDesigner && !window.expeditionDesignerInitialized) {
                        console.log('Initializing expedition designer...');
                        window.initExpeditionDesigner();
                        window.expeditionDesignerInitialized = true;
                    }
                    // Load expedition data
                    if (window.loadExpedition) {
                        console.log('Auto-loading expedition data...');
                        window.loadExpedition();
                    }
                }
                
                // If showing the settlement designer, load data
                if (pageName === 'settlements' && window.loadSettlementDesignerData) {
                    console.log('Loading settlement designer data...');
                    window.loadSettlementDesignerData();
                }
                
                // If showing the quest designer, initialize and load data
                if (pageName === 'quests') {
                    if (window.initQuestDesigner && !window.questDesignerInitialized) {
                        console.log('Initializing quest designer...');
                        window.initQuestDesigner();
                        window.questDesignerInitialized = true;
                    }
                }
            } else {
                console.error('Element not found:', page.element);
                return false;
            }

            // Update header title
            const headerTitle = document.querySelector('.header h1');
            if (headerTitle) {
                headerTitle.textContent = page.title;
            }

            // Show/hide back button based on current page
            const backButton = document.getElementById('back-to-dashboard');
            if (backButton) {
                if (pageName === 'dashboard') {
                    backButton.style.display = 'none';
                } else {
                    backButton.style.display = 'inline-block';
                }
            }

            // Update URL without reload
            if (window.history && window.history.pushState) {
                window.history.pushState({page: pageName}, page.title, `#${pageName}`);
            }

            return false; // Prevent default behavior
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            const pageName = event.state?.page || 'dashboard';
            showPage(pageName);
        });

        // Initialize page navigation
        document.addEventListener('DOMContentLoaded', function() {           
            const hash = window.location.hash.substring(1);
            const initialPage = hash && pages[hash] ? hash : 'dashboard';
            showPage(initialPage);
        });

        // Prevent default link behavior for tool cards
        document.addEventListener('click', function(event) {
            if (event.target.closest('a[onclick]')) {
                event.preventDefault();
            }
        });
    </script>
    <script src="http://localhost:8080/static/global-data.js"></script>
    <script src="http://localhost:8080/static/designer-base.js"></script>
    <script src="http://localhost:8080/static/enemy-designer-new.js"></script>
    <script src="http://localhost:8080/static/item-designer.js"></script>
    <script src="http://localhost:8080/static/perk-designer.js"></script>
    <script src="http://localhost:8080/static/expedition-designer.js"></script>
    <script src="http://localhost:8080/static/settlement-designer.js"></script>
    <script src="http://localhost:8080/static/quest-designer.js"></script>
</body>
</html>